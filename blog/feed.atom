<?xml version="1.0"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <title>Blog de Vincent Dauce</title>
    <link href="https://vincent.dauce.fr/blog" />
    <link type="application/atom+xml" rel="self" href="https://vincent.dauce.fr/blog/feed.atom" />
    <updated>2025-01-10T02:49:57+00:00</updated>
    <id>https://vincent.dauce.fr/blog/feed.atom</id>
    <author>
        <name>Vincent Dauce</name>
    </author>
                <entry>
    <id>https://vincent.dauce.fr/blog/2014-04-03-administrer-un-serveur-dedie-part-7-backup-mysql</id>
    <link type="text/html" rel="alternate" href="https://vincent.dauce.fr/blog/2014-04-03-administrer-un-serveur-dedie-part-7-backup-mysql" />
    <title>Administrer un serveur dÃ©diÃ© - part 7 : Backup MySQL</title>
    <published>2014-04-03T00:00:00+00:00</published>
    <updated>2014-04-03T00:00:00+00:00</updated>
    <author>
        <name>Vincent Dauce</name>
    </author>
    <summary type="html">Sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder,......</summary>
    <content type="html"><![CDATA[
        <p>Sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, â€¦</p>

<p>Et oui on ne le rÃ©pÃ©tera jamais assez il faut penser Ã  sauvegarder vos donnÃ©es avant tout. Le 31 mars est la journÃ©e international de la sauvegarde donc parlons en. aujourdâ€™hui.</p>

<p>La solution proposÃ©e ici est simple car nous allons sauvegarder uniquement les bases de donnÃ©es mais dans un prochain article nous pourrions voir comment sauvegarder directement un container. Lâ€™avantage serait de sauvegarder la base de donnÃ©es et les fichiers et de faciliter la restauration en cas de sinistre.</p>

<p>â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”</p>

<p>27/04/2014 : Ajout de lâ€™expiration du mot de passe au bout de 100 jours pour plus de sÃ©curitÃ© (cmd chage)</p>

<p>28/05/2014 : Modification de lâ€™offre de sauvegarde gratuite dâ€™Online, on passe de 10Go Ã  100Go cool !!!</p>

<p>â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”<br />
Nous allons mettre en place dans <strong>chaque</strong> <strong>container</strong> (ayant une base de donnÃ©es MySQL) un script qui va lister les base de donnÃ©es, les sauvegarder en local et les envoyer sur le FTP offert par Online.</p>

<h2>CrÃ©ation du compte systÃ¨me</h2>

<p>CrÃ©ation et initilisation du mdp:</p>

<pre><code class="language-bash">useradd -g www-data -m MySQLBackupManager
passwd MySQLBackupManager
chage -M 100 
</code></pre>

<p>Le compte sera MySQLBackupManager avec un mot de passe compliquÃ©e comme dâ€™habitude ğŸ™‚</p>

<p>On va nettoyer le rÃ©pertoire personnelle du compte pour ne laisser que le script nÃ©cessaire et les sauvegardes locales</p>

<p>Nettoyer le rÃ©pertoire personnel:</p>

<pre><code class="language-bash">su - MySQLBackupManager
rm -rf /home/MySQLBackupManager
mkdir scripts
mkdir tmp
mkdir logs
mkdir backups_daily
mkdir backups_weekly
</code></pre>

<p>VoilÃ  tout est en place il reste le fameux scripts mais nous allons dâ€™abord rÃ©cupÃ©rer les informations nÃ©cessaires avant.</p>

<p>Tout le reste se passe avec le compte MySQLBackupManager</p>

<h2>CrÃ©ation du compte MySQL</h2>

<p>Se connecter en root Ã  MySQL:</p>

<pre><code class="language-bash">mysql -h localhost -u root -p
</code></pre>

<p>CrÃ©ation du compte:</p>

<pre><code class="language-sql">CREATE USER 'mysql-backup-manager'@'localhost' IDENTIFIED BY 'MON_PASSWORD';
FLUSH PRIVILEGES;
EXIT;
</code></pre>

<p>Remplacer par le mot de passe que vous souhaitez.</p>

<h2>RÃ©cupÃ©rer les informations du serveur distant</h2>

<p>Dans la console Online, sur la liste des serveurs sÃ©lectionner votre serveur.</p>

<p>Dans lâ€™onglet Â« Sauvegarde Â», activer le compte FTP. Online offre gratuitement un espace de stockage de <del>10Go</del> 100Go (depuis le 28/05/2014) nâ€™est ce pas magnifique ? En plus câ€™est fait intelligement câ€™est Ã  dire que votre serveur de backup est toujours dans un autre datacenter que votre serveur donc en cas dâ€™accident (incendie) et bien vos donnÃ©es seront sauvÃ©es.</p>

<p>AprÃ¨s lâ€™activation rÃ©cupÃ©rer :</p>

<ul>
<li>lâ€™adresse FTP : dedibackup-dc2.online.net</li>
<li>le login : le nom de votre serveur sd-xxxxx</li>
<li>le mot de passe</li>
</ul>

<h2>Mise en place du script de sauvegarde</h2>

<p>RÃ©cupÃ©rer le script sur mon github :</p>

<p><a href="https://github.com/eXorus/eXorus/blob/master/MySQLBackupManager/MySQLBackupManager.sh" title="Afficher MySQLBackupManager.sh">MySQLBackupManager.sh</a> <a href="https://raw.github.com/eXorus/eXorus/master/MySQLBackupManager/MySQLBackupManager.sh" title="Back to MySQLBackupManager.sh">affichage brut</a>:</p>

<pre><code class="language-bash">!/bin/bash

#---------------------------------------------------------------#
# ParamÃ©trage de la connection MySQL                            #
#---------------------------------------------------------------#

#Nom de l'utilisateur qui lance le backup
user=mysql-backup-manager
#Machine sur laquelle on se connecte
host=localhost
#Mot de passe de l'utilisateur de backup
pass=mon_mot_de_passe_system

# Outil de dump
MYSQLDUMP=mysqldump
#Outil de check
MYSQLCHECK=mysqlcheck
# Options passÃ©es |  MYSQLDUMP
OPTIONS="--add-drop-database  --add-drop-table --complete-insert --routines --triggers --max_allowed_packet=250M --force"

#---------------------------------------------------------------#
# ParamÃ©trage de la sauvegarde                                  #
#---------------------------------------------------------------#

# RÃ©pertoire temporaire pour stocker les backups
TEMPORAIRE="/home/MySQLBackupManager/tmp"

# Nom du serveur
MACHINE="$(hostname)"

# Date jour
DATE_DAILY="$(date +"%Y-%m-%d")"
#Retention des sauvegardes journaliÃ¨res
DAILY_RETENTION=15

# Date semaine
DATE_WEEKLY="$(date +"%U")"
#Retention des sauvegardes hebdomadaires
WEEKLY_RETENTION=200

# Nom des fichiers de backup
# RÃ©pertoire de destination du backup
REP_DAILY="backups_daily"
REP_WEEKLY="backups_weekly"
DESTINATION_DAILY="/home/MySQLBackupManager/"$REP_DAILY
DESTINATION_WEEKLY="/home/MySQLBackupManager/"$REP_WEEKLY
FICHIER_BACKUP_DAILY=$MACHINE"_BACKUP_MYSQL_"$DATE_DAILY".tar.gz"
FICHIER_BACKUP_WEEKLY=$MACHINE"_BACKUP_MYSQL_S"$DATE_WEEKLY".tar.gz"

#Informations FTP
LOGIN_FTP=sd-xxxx
PASS_FTP=mon_mot_de_passe_ftp
HOST_FTP=dedibackup-dc2.online.net
FTP_DAILY=$MACHINE"/"$REP_DAILY
FTP_WEEKLY=$MACHINE"/"$REP_WEEKLY

#---------------------------------------------------------------#
# Process de sauvegarde                                         #
#---------------------------------------------------------------#
# CrÃ©ation du rÃ©pertoire temporaire
if [ -d $TEMPORAIRE ];
then
  echo "Le repertoire "$TEMPORAIRE" existe.";
else
  mkdir $TEMPORAIRE;
  echo "CrÃ©ation du repertoire "$TEMPORAIRE".";
fi

# On construit la liste des bases de donnÃ©es
BASES="$(mysql -u $user -h $host -p$pass -Bse 'show databases')"

# On lance le dump des bases
for db in $BASES
do
  if [ $db != "information_schema" ]; then
    #On lance un check et une analyse pour chaque base de donnÃ©es
    $MYSQLCHECK -u $user -h $host -p$pass -c -a $db
    # On lance un mysqldump pour chaque base de donnÃ©es
    $MYSQLDUMP -u $user -h $host -p$pass $OPTIONS $db -R &gt; $TEMPORAIRE"/"$MACHINE"-"$db"-"$DATE_DAILY".sql";
  fi
done

# CrÃ©ation du rÃ©pertoire de destination journalier
if [ -d $DESTINATION_DAILY ];
then
  echo "Le repertoire "$DESTINATION_DAILY" existe.";
else
  mkdir $DESTINATION_DAILY;
  echo "CrÃ©ation du repertoire "$DESTINATION_DAILY".";
fi

# CrÃ©ation de l'archive contenant tout les dump
#Cette archive est stockÃ©e dans le dossier dÃ©fini pour la sauvegarde
cd $TEMPORAIRE
tar -cvzf $DESTINATION_DAILY"/"$FICHIER_BACKUP_DAILY *

# CrÃ©ation du rÃ©pertoire de destination semaine
if [ -d $DESTINATION_WEEKLY ];
then
  echo "Le repertoire "$DESTINATION_WEEKLY" existe.";
else
  mkdir $DESTINATION_WEEKLY;
  echo "CrÃ©ation du repertoire "$DESTINATION_WEEKLY".";
fi

#Copie de la sauvagarde semaine
if [ -f $DESTINATION_WEEKLY"/"$FICHIER_BACKUP_WEEKLY  ];
then
    echo "La sauvegarde "$DESTINATION_WEEKLY"/"$FICHIER_BACKUP_WEEKLY" existe.";
else
    echo "CrÃ©ation de la sauvegarde "$DESTINATION_WEEKLY"/"$FICHIER_BACKUP_WEEKLY".";
    cp $DESTINATION_DAILY"/"$FICHIER_BACKUP_DAILY $DESTINATION_WEEKLY"/"$FICHIER_BACKUP_WEEKLY
fi

# On supprime le fichier
find $DESTINATION_DAILY -type f -mtime +$DAILY_RETENTION | xargs -r rm
find $DESTINATION_WEEKLY -type f -mtime +$WEEKLY_RETENTION | xargs -r rm

# On transfere l'archive par FTP
lftp $HOST_FTP&lt;&lt;SCRIPTFTP
user $LOGIN_FTP $PASS_FTP
mirror -R $DESTINATION_DAILY"/" $FTP_DAILY"/"
mirror -R $DESTINATION_WEEKLY"/" $FTP_WEEKLY"/"
du -hs /
bye
SCRIPTFTP

# On suprime le rÃ©pertoire temporaire
if [ -d $TEMPORAIRE ]; then
  rm -Rf $TEMPORAIRE
fi
</code></pre>

<p>RÃ©cupÃ©rer, DÃ©poser et donner les droits:</p>

<pre><code class="language-bash">cd /home/MySQLBackupManager/scripts
wget https://raw.githubusercontent.com/eXorus/eXorus/master/MySQLBackupManager/MySQLBackupManager.sh
chmod 700 MySQLBackupManager.sh
vi MySQLBackupManager.sh
</code></pre>

<p>On rÃ©cupÃ¨re le script on ajout les droits uniquement pour le compte MySQLBackupManager et ensuite on lâ€™Ã©dite pour modifier quelques informations :</p>

<ul>
<li>user /host / pass : pour se connecter Ã  la machine ici nous sommes en local câ€™est donc plus simple mais ca fonctionne aussi avec un serveur distant</li>
<li>LOGIN_FTP / PASS_FTP / HOST_FTP : pour se connecter au serveur distant (FTP) qui va rÃ©cupÃ©rer les sauvegardes</li>
</ul>

<p>Câ€™est tout.</p>

<p>Pour que le script fonctionne nous devons installer 2 outils :</p>

<ul>
<li>aptitude install cron : pour automatiser la sauvegarde</li>
<li>aptitude install lftp : pour faire du ftp sur le serveur distant</li>
</ul>

<p>Ensuite nous devons configurer le cron (tÃ¢che planifiÃ©e qui va sâ€™exÃ©cuter tous les jours Ã  4h du matin)</p>

<p>Crontab:</p>

<pre><code class="language-bash">crontab -e
        0 4 * * * /home/MySQLBackupManager/scripts/MySQLBackupManager.sh &gt;&gt;/home/MySQLBackupManager/logs/MySQLBackupManager.log
</code></pre>

<p>Vous pouvez tester le script manuellement la premiÃ¨re fois pour vÃ©rifier que tout fonctionne correctement :</p>

<p>Tester le script manuellement:</p>

<pre><code class="language-bash">./MySQLBackupManager
</code></pre>

<p>Et vÃ©rifier avec les logs que tout se passe bien.</p>

<h2>Quoi sauvegarder ?</h2>

<p>VoilÃ  nos sauvegardes MySQL sont en place reste juste Ã  indiquer les bases Ã  sauvegarder. Pour cela il suffit de donner au compte mysql-backup-manager les droits suffisants.</p>

<p>Se connecter en root Ã  MySQL:</p>

<pre><code class="language-bash">mysql -h localhost -u root -p
</code></pre>

<p>Activer la sauvegarde de la BDD mydatabase:</p>

<pre><code class="language-sql">GRANT SELECT , INSERT , LOCK TABLES ON `mydatabase` . * TO 'mysql-backup-manager'@'localhost';
FLUSH PRIVILEGES;
EXIT:
</code></pre>

<p>A reproduire sur toutes les bases Ã  sauvegarder. Jâ€™ai mis Ã  jour le post concernant la <a href="http://vincent.dauce.fr/administrer-un-serveur-dedie-part-6-espace-web/" title="Administrer un serveur dÃ©diÃ© â€“ part 6 : Espace Web">crÃ©ation dâ€™un espace web</a> pour lâ€™activer par dÃ©faut.</p>

<h2>Sauvegarde sur le FTP</h2>

<p>Sur le FTP Online vous retrouverez la structure suivante :</p>

<ul>
<li>[CT101]

<ul>
<li>backups_daily

<ul>
<li>CT101_BACKUP_MYSQL_2014-01-28.tar.gz</li>
<li>CT101_BACKUP_MYSQL_2014-01-29.tar.gz</li>
<li>â€¦</li>
</ul></li>
<li>backups_weekly

<ul>
<li>CT101_BACKUP_MYSQL_S04.tar.gz</li>
<li>CT101_BACKUP_MYSQL_S05.tar.gz</li>
<li>â€¦</li>
</ul></li>
</ul></li>
<li>[CT102]

<ul>
<li>backups_daily

<ul>
<li>â€¦</li>
</ul></li>
<li>backups_weekly

<ul>
<li>â€¦</li>
</ul></li>
</ul></li>
</ul>

<p>Câ€™est largement suffisant pour avoir toujours la bonne sauvegarde au bon moment. Attention vous Ãªtes limitÃ©s Ã  100 fichiers sur le serveur FTP dâ€™Online.</p>

<p>DerniÃ¨re chose il faut penser Ã  vÃ©rifier le lendemain que votre sauvegarde a bien fonctionner et essayer de la restaurer dans une base de donnÃ©es vide et voir que les donnÃ©es ne sont pas corrompues sinon tout le travail ci-dessous nâ€™aura servi Ã  rien.</p>

<p>Â« Save today, Tomorrow is too late Â»</p>
    ]]></content>
</entry>
            <entry>
    <id>https://vincent.dauce.fr/blog/2014-03-08-php-securite-faille-xss</id>
    <link type="text/html" rel="alternate" href="https://vincent.dauce.fr/blog/2014-03-08-php-securite-faille-xss" />
    <title>Php SÃ©curitÃ© â€“ DÃ©couverte de la faille XSS et comment s&#039;en protÃ©ger</title>
    <published>2014-03-08T00:00:00+00:00</published>
    <updated>2014-03-08T00:00:00+00:00</updated>
    <author>
        <name>Vincent Dauce</name>
    </author>
    <summary type="html">Nous allons Ã©tudier dans cet article la faille Cross-Site Scripting (XSS) et apprendre Ã  sâ€™en protÃ©ger.



Cette faille est la plus importante aprÃ¨s les injections SQL que nous avons dÃ©jÃ  Ã©tudiÃ©. Donc il est nÃ©cessaire de la connaitre pour......</summary>
    <content type="html"><![CDATA[
        <p>Nous allons Ã©tudier dans cet article la faille <a href="http://fr.wikipedia.org/wiki/Cross-site_scripting">Cross-Site Scripting</a> (XSS) et apprendre Ã  sâ€™en protÃ©ger.</p>

<h2>Introduction</h2>

<p>Cette faille est la plus importante <a href="http://vincent.dauce.fr/php-securite-injection-sql/" title="Php SÃ©curitÃ© â€“ DÃ©couverte des Injections SQL et comment sâ€™en protÃ©ger">aprÃ¨s les injections SQL que nous avons dÃ©jÃ  Ã©tudiÃ©</a>. Donc il est nÃ©cessaire de la connaitre pour sâ€™en protÃ©ger.</p>

<p>Le principe de cette faille est dâ€™injecter des donnÃ©es spÃ©cifiques sur un site web. Celui-ci va lâ€™afficher sans en contrÃ´ler la nature et provoquer une importante faille Ã  tous les visiteurs qui lâ€™afficherons.</p>

<h2>â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”</h2>

<p>07/06/2014 : Ajout du lien vers le XSS Game Ã  la fin</p>

<h2>â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”</h2>

<h2>DÃ©couverte de la faille</h2>

<h3>Exemple 1 : Avec du code HTML (XSS stockÃ© ou permanent)</h3>

<p>Sur la page dâ€™inscription je saisi mon login avec du code HTML :</p>

<pre><code class="language-bash">&lt;strong&gt;eXorus&lt;/strong&gt;
</code></pre>

<p>La faille va se voir quand je vais me connecter car le site non protÃ©gÃ© affiche mon login sans le traiter donc je vais voir mon login en gras : <strong>eXorus</strong></p>

<p>Et les autres utilisateurs le verront aussi par exemple sur le forum ou lâ€™on affiche le nom de lâ€™auteur dâ€™un post, toujours en gras.</p>

<p>Dans ce cas câ€™est pas trÃ¨s mÃ©chant et ca peut mÃªme Ãªtre jolie si on dÃ©cide de mettre du code HTML avec du CSS pour avoir de la couleur, â€¦</p>

<h3>Exemple 2 : Avec du code Javascript (XSS rÃ©flÃ©chi ou non permanent)</h3>

<p>Imaginons un forum avec des posts sur plusieurs pages, quand je clique sur page suivante jâ€™ai des URL de type :</p>

<p>http://www.monforum.fr/informatique?p=1</p>

<p>http://www.monforum.fr/informatique?p=2</p>

<p>http://www.monforum.fr/informatique?p=3</p>

<p>Sur chaque page on mâ€™indique que je suis sur la page 1 ou 2 ou 3 â€¦ mais cette donnÃ©e nâ€™est pas protÃ©gÃ©e donc si je change moi mÃªme la valeur de la variable p dans lâ€™URL la faille va se voir. Par exemple :</p>

<pre><code class="language-bash">http://www.monforum.fr/informatique?p=&lt;script type="text/javascript"&gt;alert('Faille');&lt;/script&gt;
</code></pre>

<p>Quand je vais aller sur cette URL comme on affiche la variable p sans la protÃ©ger je vais avoir une popup Javascript qui va mâ€™afficher Â« Faille Â». Encore une fois on est pas trÃ¨s mÃ©chant et en plus lâ€™attaquant va sâ€™attaquer lui mÃªme car personne nâ€™ira jamais sur cette URL â€¦ quoi que Ã§a arrive des fois ğŸ™‚ câ€™est pour ca quâ€™il faut Ã©viter de suivre les URL quâ€™on nous donne sans y rÃ©flÃ©chir.</p>

<p>Conclusion</p>

<p>Dans les 2 exemples ci-dessous nous avons Ã©tÃ© trÃ¨s gentil mais nous pouvons faire beaucoup plus de dÃ©gats par exemple au lieu simplement dâ€™afficher un texte avec une couleur ou dâ€™afficher une popup Javascript on peut rediriger le visiteur vers un site pirate qui imitera la site attaquÃ© avec le mÃªme design. Donc le visiteur ne verra pas quâ€™il a changÃ© de site et ensuite tout peut arriver.</p>

<p>Reprenons lâ€™exemple 1 en plus mÃ©chant :</p>

<ol>
<li>Je mâ€™inscris sur un forum http://forum.fr avec le login :</li>
</ol>

<pre><code class="language-bash">&lt;script type=â€text/javascriptâ€&gt;window.location.href=â€http://forumpirate.fr/login";&lt;/script&gt;
</code></pre>

<ol>
<li>Je vais Ã©crire un premier post sur le forum intÃ©ressant pour toucher le plus de personnes possibles</li>
<li>Toutes les personnes qui vont voir mon post vont voir mon login et donc le Javascript va sâ€™exÃ©cuter pour les rediriger vers la page http://forumpirate.fr/login</li>
<li>Sur ce nouveau forum pirate que jâ€™ai crÃ©Ã© moi mÃªme jâ€™ai reproduit Ã  lâ€™identique le site initial http://forum.fr</li>
<li>Donc le visiteur ne va pas comprendre pourquoi il est dÃ©connectÃ© tout dâ€™un coup en voulant lire un post intÃ©ressant mais il va pas chercher plus loin et il va saisir son login et mot de passe sur le forum pirate</li>
<li>Sur mon forum pirate le login et le mot de passe seront rÃ©cupÃ©rÃ©s pour Ãªtre sauvegardÃ© dans ma base en clair pour pouvoir les lire et les utiliser contre eux</li>
</ol>

<p>Dans le mÃªme genre mais au lieu de rediriger vers un site pirate on redirigerais sur une autre page du forum qui serait accessible uniquement aux administrateurs du forum comme une page pour supprimer un post.</p>

<p>Lâ€™URL pour supprimer un post est http://forum.fr/post-delete.php?id=66</p>

<p>Mais cette URL nâ€™est autorisÃ© que pour les comptes administrateurs donc si je suis un pirate et que je veux supprimer le post 66 il suffit de mâ€™inscrire sur le forum avec le login :</p>

<pre><code class="language-bash">&lt;script type=â€text/javascriptâ€&gt;window.location.href=â€http://forum.fr/post-delete.php?id=66";&lt;/script&gt;
</code></pre>

<p>Ecrire un nouveau post dans le forum et espÃ©rer quâ€™un administrateur passe. Pour les utilisateurs normaux ils seront redirigÃ©s vers lâ€™URL mais comme ils nâ€™ont pas les droits Ã§a mettra un message dâ€™erreur mais pour lâ€™administrateur Ã§a supprimera le post.</p>

<h2>Protection</h2>

<p>La protection est simple : <strong>Never Trust User Input (Ne jamais faire confiance aux donnÃ©es des utilisateurs)</strong></p>

<ul>
<li>Le risque de cette faille est uniquement lors de lâ€™affichage donc il faut nettoyer la donnÃ©e Ã  afficher avant de lâ€™afficher.</li>
<li>Nettoyer la donnÃ©e une seule fois</li>
<li>Valider les donnÃ©es lors de la rÃ©cupÃ©ration :

<ul>
<li>Limiter les caractÃ¨res autorisÃ©s pour un login (alphanumÃ©rique)</li>
<li>ContrÃ´ler la forme dâ€™une adresse mail (xxx@xxx.xxx)</li>
<li>Limiter le nombre de caractÃ¨res un prÃ©nom de 200 caractÃ¨res est ce que Ã§a existe ?</li>
<li>Un chiffre est un chiffre donc ne pas permettre de mettre des lettres</li>
<li>â€¦</li>
</ul></li>
</ul>

<pre><code class="language-php">$userInput = '&lt;strong&gt;eXorus&lt;/strong&gt;';

// [Faille XSS] Affiche eXorus en gras
echo $userInput;

// [XSS SÃ©curisÃ©] Affiche &lt;strong&gt;eXorus&lt;/strong&gt;
echo htmlspecialchars($userInput, ENT_QUOTES);
</code></pre>

<p>Lâ€™unique mÃ©thode magique Ã  utiliser en PHP pour se protÃ©ger des failles XSS est <a href="http://www.php.net/manual/fr/function.htmlspecialchars.php">htmlspecialchars()</a> avec le paramÃ¨tre ENT_QUOTES qui convertit les guillemets simples en plus.</p>

<h2>Comment Ã§a fonctionne ?</h2>

<p>Si tu affiches du code HTML, CSS ou Javascript il sera interprÃ©tÃ© par le navigateur du visiteur. Pour Ã©viter cela on affiche les caractÃ¨res qui ont des significations spÃ©ciales en HTML/CSS et Javascript sous forme dâ€™entitÃ©s HTML.</p>

<p>Pour le code ci-dessous dans le navigateur nous allons voir :</p>

<p><strong>eXorus</strong></p>

<p>&lt;strong&gt;eXorus&lt;/strong&gt;</p>

<p>et dans le code source nous allons voir :</p>

<p>&lt;strong&gt;eXorus&lt;/strong&gt;</p>

<p>&amp;lt;strong&amp;gt;eXorus&amp;lt;/strong&amp;gt;</p>

<p>De cette maniÃ¨re le code HTML/CSS et Javascript sâ€™affiche proprement dans le navigateur sans Ãªtre interprÃ©tÃ© (ce que nous recherchons).</p>

<p>Et merci Ã  lâ€™auteur ci-dessous qui mâ€™a donnÃ© envie dâ€™Ã©crire sur cette faille :</p>

<p>Source (English) : <a href="http://www.sunnytuts.com/article/preventing-cross-site-scripting-xss">http://www.sunnytuts.com/article/preventing-cross-site-scripting-xss</a></p>

<p>Pour finir je vous laisse vous entrainer sur un XSS Game : <a href="https://xss-game.appspot.com/">https://xss-game.appspot.com/</a></p>
    ]]></content>
</entry>
            <entry>
    <id>https://vincent.dauce.fr/blog/2014-03-08-vpmel-mon-premier-projet-open-source</id>
    <link type="text/html" rel="alternate" href="https://vincent.dauce.fr/blog/2014-03-08-vpmel-mon-premier-projet-open-source" />
    <title>Mon premier projet Open Source php-mime-mail-parser</title>
    <published>2014-03-08T00:00:00+00:00</published>
    <updated>2014-03-08T00:00:00+00:00</updated>
    <author>
        <name>Vincent Dauce</name>
    </author>
    <summary type="html">Contrairement aux autres articles celui ci sera moins technique, je vais vous raconter une histoire comment jâ€™ai crÃ©Ã© mon premier projet Open Source php-mime-mail-parser.

Ce projet mâ€™a permis pour la premiÃ¨re fois de :


Partager mon code et......</summary>
    <content type="html"><![CDATA[
        <p>Contrairement aux autres articles celui ci sera moins technique, je vais vous raconter une histoire comment jâ€™ai crÃ©Ã© mon premier projet Open Source <a href="https://github.com/eXorus/php-mime-mail-parser">php-mime-mail-parser</a>.</p>

<p>Ce projet mâ€™a permis pour la premiÃ¨re fois de :</p>

<ul>
<li>Partager mon code et obtenir des retours</li>
<li>Utiliser GitHub pour distribuer mon code</li>
<li>Mettre en place des tests unitaires</li>
<li>Mettre en place un package avec Composer</li>
</ul>

<h2>Histoire</h2>

<p>A mon travail nous utilisions <a href="www.yopmail.com">www.yopmail.com</a> pour se crÃ©er des adresses mails fictives sans avoir Ã  crÃ©er de compte et en pouvant quand mÃªme lire les emails. Comme tous les dÃ©veloppeurs Web, quand il sâ€™agit de tester un site il faut crÃ©er plusieurs comptes, vÃ©rifier les emails de confirmation de compte, les emails de commandes, â€¦ et yopmail est bien pratique pour ca.</p>

<p>Mais nous avions un problÃ¨me, câ€™est que les automates qui effectuaient les tests automatisÃ©s la nuit Ã©tait pris pour des robots malveillants donc Yopmail affichait des <a href="http://fr.wikipedia.org/wiki/CAPTCHA">captchas</a> et donc on se retrouvait avec des tests en erreur le matin.</p>

<p>Curieux comme je suis jâ€™ai voulu comprendre comment Yopmail fonctionnait et si il Ã©tait possible de reproduire ce systÃ¨me. Je suis entrÃ©e dans le monde des mails et du parsing ğŸ™‚</p>

<p>AprÃ¨s ma petite analyse jâ€™ai compris quâ€™il me fallait :</p>

<ul>
<li>Un serveur mail (Postfix) pour recevoir les mails et les envoyer sur un script PHP</li>
<li>Un script PHP pour parser le mail et lâ€™insÃ©rer dans une base de donnÃ©es en rÃ©cupÃ©rant :

<ul>
<li>lâ€™expÃ©diteur</li>
<li>le destinataire</li>
<li>le titre</li>
<li>le corps du mail format texte et html</li>
<li>les fichiers attachÃ©s</li>
<li>â€¦</li>
</ul></li>
<li>Une application Web pour visualiser les mails en base de donnÃ©es</li>
</ul>

<p>Le plus compliquÃ© fut le script pour parser un mail en PHP et câ€™est lÃ  que jâ€™ai dÃ©couvert <a href="https://code.google.com/p/php-mime-mail-parser/">php-mime-mail-parser</a></p>

<p>Projet Open Source sur Google Code qui semblait correspondre Ã  mes attentes. Jâ€™ai donc commencÃ© Ã  tÃ©lÃ©charger cette classes PHP pour lâ€™utiliser dans mon application Web. Mon application a commencÃ© Ã  Ãªtre utilisÃ©e par les Ã©quipes de tests Ã  mon boulot et les anomalies sont arrivÃ©es essentiellement sur le parsing.</p>

<p>Comme le code de cette classe Ã©tait complexe (ie : il fallait connaitre les <a href="http://fr.wikipedia.org/wiki/Multipurpose_Internet_Mail_Extensions">standards des mails</a>) je me contentais bien souvent dâ€™essayer de trouver le correctif dans les commentaires <a href="https://code.google.com/p/php-mime-mail-parser/issues/list">des anomalies de cette classe</a>.</p>

<p>Au bout dâ€™un moment Ã§a commenÃ§ait Ã  Ãªtre vraiment complexe je modifiait toujours le mÃªme fichier car il y en a quâ€™un, les gens parlaient de ligne Ã  modifier mais comme câ€™Ã©tait pas la premiÃ¨re modification Ã§a correspondait plus et puis je ne savais jamais si un correctif nâ€™entraÃ®nait pas dâ€™autres rÃ©gressions ou Ã©crasait un correctif que jâ€™avais mis en place quelques semaine plus tÃ´t.</p>

<p>Câ€™Ã©tait le bordel et Ã§a ne pouvait plus continuer comme Ã§a surtout pour quelquâ€™un qui prÃ´ne la QualitÃ© dans son boulot.</p>

<h2>La naissance dâ€™un fork</h2>

<p>La solution crÃ©er un fork sur GitHub qui est la plateforme Ã  la mode pour partager son code. Ma mÃ©thode pour rÃ©soudre ma problÃ©matique :</p>

<ul>
<li>CrÃ©er un bug sur GitHub quand je constate un problÃ¨me</li>
<li>CrÃ©er un test unitaire qui reproduit ce bug</li>
<li>Corriger le bug</li>
<li>Relancer mes tests unitaires pour voir que tout est vert</li>
<li>Commit</li>
</ul>

<p>Jâ€™ai donc tÃ©lÃ©chargÃ© Ã  nouveau le code du projet, je lâ€™ai dÃ©posÃ© sur Github et jâ€™ai commencÃ© Ã  lire tous les bugs sur Google Code pour essayer de les reproduire.</p>

<p>Voici donc le bÃ©bÃ© sur GitHub : <a href="https://github.com/eXorus/php-mime-mail-parser">eXorus/php-mime-mail-parser</a></p>

<p>A ce jour il y a plus de 20 tests vÃ©rifiant 53 assertions, jâ€™en suis fier. Merci Ã  Juan Treminio qui mâ€™a permis dâ€™apprendre les tests unitaires sous PHP avec son article <a href="https://jtreminio.com/2013/03/unit-testing-tutorial-introduction-to-phpunit/">Unit Testing Tutorial</a> en 6 parties.</p>

<h2>La contribution</h2>

<p>La premiÃ¨re fois que lâ€™on reÃ§oit une contribution sur un projet Open Source est indescriptible, câ€™Ã©tait il y a 5 mois avec le message suivant :</p>

<blockquote>
  <p>Over the last few months, I've tested around 10 PHP email parsing solutions. eXorus, you've nailed it! My assessment is that your modifications to MimeMailParser.class.php have made it the most effective php email parser around in terms of performance, foreign character encoding, attachment handling, and ease of use (once MailParse is installed).</p>
  
  <p>I've reposted your code with nothing but minor formatting and syntax tweaks. Ignore if you wish :)</p>
</blockquote>

<p>Jâ€™Ã©tais heureux et fier que lâ€™on trouve mon projet intÃ©ressant. Ã‡a reste un petit projet mais de temps en temps je reÃ§ois des modifications Ã  effectuer ou des forks qui se crÃ©Ã©s Ã  partir de mon code. Jâ€™essaye de regarder si il y a des bonnes idÃ©es Ã  reprendre on ne sait jamais.</p>

<h2>Distribuer mon package</h2>

<p>La mode est dâ€™utiliser <a href="https://getcomposer.org/">Composer</a> pour distribuer des packages PHP donc jâ€™ai proposÃ© mon package sur <a href="https://packagist.org/packages/exorus/php-mime-mail-parser">Packagist</a> pour faciliter son utilisation.</p>

<p>Et a ce jour le package a Ã©tÃ© installÃ© 455 fois dont 61 fois sur le dernier mois. Un petit succÃ¨s pour moi.</p>

<h2>La suite</h2>

<p>Il reste des contributions Ã  traiter et vÃ©rifier, rendre le code plus propre et respectueux des standards PHP.</p>

<p>Etudier comment fonctionne les releases pour Ã©viter de toujours dÃ©velopper sur la branche master.</p>

<p>Et surement plein dâ€™autres choses, mais avant tout il faut du temps.</p>
    ]]></content>
</entry>
            <entry>
    <id>https://vincent.dauce.fr/blog/2014-03-03-php-securite-injection-sql</id>
    <link type="text/html" rel="alternate" href="https://vincent.dauce.fr/blog/2014-03-03-php-securite-injection-sql" />
    <title>Php SÃ©curitÃ© â€“ DÃ©couverte des Injections SQL et comment sâ€™en protÃ©ger</title>
    <published>2014-03-03T00:00:00+00:00</published>
    <updated>2014-03-03T00:00:00+00:00</updated>
    <author>
        <name>Vincent Dauce</name>
    </author>
    <summary type="html">Nous allons Ã©tudier dans cet article les injections SQL et apprendre Ã  sâ€™en protÃ©ger.



Cette faille est la plus importante et celle que nous connaissons le mieux. Mais avant avant de parler des failles plus complexe comme XSS vÃ©rifions que vous......</summary>
    <content type="html"><![CDATA[
        <p>Nous allons Ã©tudier dans cet article les <a href="http://fr.wikipedia.org/wiki/Injection_SQL">injections SQL</a> et apprendre Ã  sâ€™en protÃ©ger.</p>

<h2>Introduction</h2>

<p>Cette faille est la plus importante et celle que nous connaissons le mieux. Mais avant avant de parler <a href="http://vincent.dauce.fr/php-securite-faille-xss/" title="Php SÃ©curitÃ© â€“ DÃ©couverte de la faille XSS et comment sâ€™en protÃ©ger">des failles plus complexe comme XSS</a> vÃ©rifions que vous avez dÃ©jÃ  une base en sÃ©curitÃ©. Nous allons Ã©tudier les impacts de cette faille, la comprendre et enfin sâ€™en protÃ©ger.</p>

<p>Cette faille se situe entre lâ€™application et sa base de donnÃ©es, le principe est dâ€™envoyer une requÃªte non prÃ©vue par le dÃ©veloppeur pour compromettre la sÃ©curitÃ© dâ€™une application.</p>

<h2>DÃ©couverte de la faille</h2>

<h3>Exemple 1 : Se connecter en tant quâ€™administrateur sans connaitre le mot de passe</h3>

<p>Imaginer le code suivant pour vous connecter Ã  votre site :</p>

<pre><code class="language-php">$login = $_POST['login'];
$password = $_POST['password'];

$result = mysql_query("SELECT user_id FROM users WHERE login = '".$login."' AND password = '".$password."'");
</code></pre>

<p>La requÃªte devrait fonctionner uniquement si le login et le mot de passe sont correcte mais câ€™est pas le cas. Pour lâ€™instant notre requÃªte ressemblerait Ã  Ã§Ã  :</p>

<pre><code class="language-sql">SELECT user_id FROM users WHERE login = 'admin' AND password = 'azerty'
</code></pre>

<p>Mais nous pouvons utiliser une injection SQL pour se connecter sans mot de passe avec nâ€™importe quel login.</p>

<p>Avec le login suivant : adminâ€™â€“</p>

<p>et nâ€™importe quel mot de passe car de toute maniÃ¨re il ne sera pas pris en compte la requÃªte devient :</p>

<pre><code class="language-sql">SELECT user_id FROM users WHERE login = 'admin'--' AND password = 'azerty'

--Equivalent Ã 
SELECT user_id FROM users WHERE login = 'admin'
</code></pre>

<p>Les caractÃ¨res Â« â€” Â» sont interprÃ©tÃ©s en SQL comme le dÃ©but dâ€™un commentaire donc comme vous pouvez le voir ci-dessus la requÃªte SQL nâ€™a plus le sens que lâ€™on souhaitait. Elle vÃ©rifie le login mais plus le mot de passe donc il suffit dâ€™avoir le login dâ€™une personne pour se connecter. Facile !!!</p>

<h3>Exemple 2 : Supprimer des donnÃ©es</h3>

<p>Imaginons maintenant une page dâ€™un blog http://monblog.fr/view.php?id=66 avec le code PHP suivant :</p>

<pre><code class="language-php">$id = $_GET['id'];

$result = mysql_query("SELECT post_text FROM posts WHERE post_id = '".$id."'");
</code></pre>

<p>On pourrait penser que le risque est faible par rapport Ã  notre premier exemple. Au pire le pirate pourra lire un autre post sur le blog et bien non. Si on change lâ€™URL pour http://monblog.fr/view.php?id=65â€²;DROP TABLE posts;â€“</p>

<p>Ã‡a va lire le post 65 mais en mÃªme temps supprimer la table avec tous les posts â€¦ bye bye le blog jâ€™espÃ¨re que vous avez des sauvegardes rÃ©guliÃ¨res.</p>

<p>La requÃªte attendue est :</p>

<pre><code class="language-sql">SELECT post_text FROM posts WHERE post_id = '66'
</code></pre>

<p>La requÃªte obtenue ou plutÃ´t les requÃªtes obtenues sont :</p>

<pre><code class="language-sql">SELECT post_text FROM posts WHERE post_id = '65';DROP TABLE posts;--'
</code></pre>

<p>Donc comme nous avons pu le voir tous les caractÃ¨res spÃ©cifiques Ã  SQL doivent Ãªtre protÃ©gÃ©s :</p>

<ul>
<li>Â« â€” Â» : qui permet de commenter tous ce qui est aprÃ¨s</li>
<li>Â« ; Â» : qui permet dâ€™exÃ©cuter plusieurs requÃªtes les unes aprÃ¨s les autres</li>
</ul>

<h2>Protection</h2>

<p>La protection est simple : <strong>Never Trust User Input (Ne jamais faire confiance aux donnÃ©es des utilisateurs)</strong></p>

<p>Avant il fallait utiliser des fonctions spÃ©cifiques Ã  PHP (mysql_real_escape_string ou caster avec int) pour Ã©chapper les caractÃ¨res mais Ã§a câ€™Ã©tait avant. Maintenant que lâ€™extension mysql_* est obsolÃ¨te vous devez utiliser PDO pour interagir avec une base de donnÃ©e.</p>

<p><a href="http://fr2.php.net/manual/fr/class.pdo.php">Lâ€™extension PDO</a> permet de gÃ©rer lâ€™Ã©chappement des caractÃ¨res pour protÃ©ger vos requÃªtes SQL des pirates Ã  travers les requÃªtes prÃ©parÃ©es.</p>

<p>Si on revient sur nos 2 exemples ci-dessous nous devrions Ã©crire les requÃªtes de cette maniÃ¨re :</p>

<pre><code class="language-php">$login = $_POST['login'];
$password = $_POST['password'];

$query = $pdo-&gt;prepare("SELECT user_id FROM users WHERE login = :login AND password = :password ");

$query-&gt;bindValue(':login', $login, PDO::PARAM_STR);
$query-&gt;bindValue(':password', $password, PDO::PARAM_STR);

$query-&gt;execute();
</code></pre>

<p>Ou pour le second exemple :</p>

<pre><code class="language-php">$id = $_GET['id'];

$query = $pdo-&gt;prepare("SELECT post_text FROM posts WHERE post_id = :post_id");

$query-&gt;bindValue(':post_id', $id, PDO::PARAM_INT);

$query-&gt;execute();
</code></pre>

<p>La requÃªte SQL est Ã©crite avec des labels commenÃ§ant par Â« : Â». Ensuite vous assignez des valeurs aux labels en indiquant le type des donnÃ©es :</p>

<ul>
<li>PARAM_STR pour une chaÃ®ne de caractÃ¨res</li>
<li>PARAM_INT pour un entier</li>
<li>â€¦ <a href="http://www.php.net/manual/fr/pdo.constants.php">pour la liste exhaustive</a></li>
</ul>

<h2>Comment Ã§a fonctionne ?</h2>

<p>Toutes les requÃªtes prÃ©parÃ©es Ã©crites avec PDO sont sÃ©curisÃ©es car lâ€™objectif de ces requÃªtes est justement de sÃ©parer les donnÃ©es de la structure de la requÃªte.</p>

<p>Attention de bien utiliser les bindValue pour les paramÃ¨tres de vos requÃªtes sinon vous ne serez pas protÃ©gÃ©.</p>

<p>Attention sur les caractÃ¨res Â« % Â» et Â« _ Â» ne sont pas Ã©chappÃ©s donc dans le cas dâ€™une requÃªte avec LIKE comme opÃ©rateur si la variable comprend un des 2 caractÃ¨res il sera transmis tel quel Ã  la BDD.</p>

<p>Pour aller plus loin avec PDO je vous invite Ã  lire le <a href="http://fmaz.developpez.com/tutoriels/php/comprendre-pdo/">tuto de Francois Mazerolle sur developpez</a></p>

<p>Merci Ã  lâ€™auteur ci-dessous qui mâ€™a donnÃ©e envie dâ€™Ã©crire cette sÃ©rie dâ€™article :</p>

<p>Source (English) : <a href="http://www.sunnytuts.com/article/php-security-sql-injection">http://www.sunnytuts.com/article/php-security-sql-injection</a></p>
    ]]></content>
</entry>
            <entry>
    <id>https://vincent.dauce.fr/blog/2014-02-15-administrer-un-serveur-dedie-part-6-espace-web</id>
    <link type="text/html" rel="alternate" href="https://vincent.dauce.fr/blog/2014-02-15-administrer-un-serveur-dedie-part-6-espace-web" />
    <title>Administrer un serveur dÃ©diÃ© - part 6 : Espace Web</title>
    <published>2014-02-15T00:00:00+00:00</published>
    <updated>2014-02-15T00:00:00+00:00</updated>
    <author>
        <name>Vincent Dauce</name>
    </author>
    <summary type="html">Vous souhaitez installer Prestashop, WordPress ou crÃ©er votre site de A Ã  Z ? et bien il vous faut un espace web que lâ€™on va crÃ©er maintenant.

Le socle est prÃ©sent puisque dans lâ€™article prÃ©cÃ©dent nous avons terminÃ© lâ€™installation du......</summary>
    <content type="html"><![CDATA[
        <p>Vous souhaitez installer Prestashop, WordPress ou crÃ©er votre site de A Ã  Z ? et bien il vous faut un espace web que lâ€™on va crÃ©er maintenant.</p>

<p>Le socle est prÃ©sent puisque dans lâ€™article prÃ©cÃ©dent nous avons terminÃ© lâ€™installation du serveur Web.</p>

<p>Cette procÃ©dure est Ã  rÃ©pÃ©ter autant de fois que vous voulez, par exemple pour ma part jâ€™ai :</p>

<ul>
<li>Ce blog bien sur : <a href="http://vincent.dauce.fr/">http://vincent.dauce.fr</a></li>
<li>La marque de mon amie avec :

<ul>
<li>un site : <a href="http://www.sage-et-sauvage.fr">http://www.sage-et-sauvage.fr</a></li>
<li>un blog : <a href="http://blog.sage-et-sauvage.fr/">http://blog.sage-et-sauvage.fr</a></li>
<li>une boutique en ligne : <a href="http://shop.sage-et-sauvage.fr/">http://shop.sage-et-sauvage.fr</a></li>
</ul></li>
<li>Le site dâ€™une association : <a href="http://www.actessen.fr/">http://www.actessen.fr</a></li>
<li>Le site dâ€™une yourte : <a href="http://yourteauborddeleau.com/">http://yourteauborddeleau.com</a></li>
</ul>

<p>â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”</p>

<p>27/04/2014 : Ajout de lâ€™expiration du mot de passe au bout de 100 jours pour plus de sÃ©curitÃ© (cmd chage)</p>

<p>29/06/2014 : Ajout de Â« Configurer le container avec un nom de domaine Â»</p>

<p>â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”</p>

<h2>AccÃ¨s Web et SFTP</h2>

<p>Pour crÃ©er un hÃ©bergement comme jâ€™utilise le mode userdir, on commence par ajouter un compte Â« blogtuto Â» dans le groupe www-data (group dâ€™Apache)</p>

<p>Ajouter un compte:</p>

<pre><code class="language-bash">useradd -g www-data -m blogtuto
passwd blogtuto
chage -M 100 blogtuto
chown -R root:www-data /home/blogtuto/
chmod -R 750 /home/blogtuto/
chown -R blogtuto:www-data /home/blogtuto/www/
chmod -R 750 /home/blogtuto/www/
</code></pre>

<p>Avec ces quelques commande plein de choses sont faites :</p>

<ul>
<li>CrÃ©ation dâ€™un compte</li>
<li>Modification du mot de passe (pour en mettre un compliquÃ© : 50 caractÃ¨res avec majuscules, minuscules, chiffres et caractÃ¨res spÃ©ciaux)</li>
<li>CrÃ©ation dâ€™un rÃ©pertoire personnel /home/blogtuto avec

<ul>
<li>/home/blogtuto/logs pour stocker les logs apache</li>
<li>/home/blogtuto/www pour stocker les fichiers web</li>
</ul></li>
<li>CrÃ©ation dâ€™une page web de bienvenue : index.html dans le dossier www</li>
<li>Mise Ã  jour des droits pour autoriser Apache Ã  servir les pages et le compte blogtuto Ã  les modifier via le SFTP.</li>
</ul>

<p>On peut dÃ©jÃ  se connecter sur le SFTP (sftp://CT101_IP_PUBLIC:SSH_PORT) et modifier la page index.html ou crÃ©er des nouveaux fichiers dans le dossier www mais il nâ€™est toujours pas possible de voir la page index.html car nous ne lâ€™avons pas autorisÃ©.</p>

<p>vi /etc/apache2/apache2.conf:</p>

<pre><code class="language-bash">UserDir enabled blogtuto
</code></pre>

<p>La ligne est Ã  rajouter juste aprÃ¨s Â« UserDir /home/*/www Â», un espace doit sÃ©parer chaque compte donc Ã  la fin on peut avoir des choses comme ca :</p>

<p>Configuration UserDir:</p>

<pre><code class="language-bash"># Configuration du module UserDir
UserDir disabled
UserDir /home/*/www
UserDir enabled blogtuto blogtuto2 blogtuto3
</code></pre>

<p>Et recharger la configuration apache2</p>

<p>Recharger apache:</p>

<pre><code class="language-bash">service apache2 reload
</code></pre>

<p>Saisir http://CT101_IP_PUBLIC/~blogtuto dans votre navigateur prÃ©fÃ©rÃ© et vous devriez voir la page index.html.</p>

<h2>AccÃ¨s MySQL</h2>

<p>On se connecte avec le compte root et le mot de passe que vous avez mis dans lâ€™article prÃ©cÃ©dent :</p>

<p>CrÃ©ation d'un accÃ¨s MySQL:</p>

<pre><code class="language-bash">mysql -h localhost -u root -p
mysql &gt; create database blogtutoDB;
mysql &gt; grant all privileges on blogtutoDB.* to blogtuto@localhost identified by 'mypasswd';
mysql &gt; flush privileges;
mysql &gt; exit;
</code></pre>

<p>Avec ces commandes nous avons crÃ©Ã© une nouvelle base de donnÃ©es blogtutoDB et avons attribuÃ©s tous les droits sur cette base uniquement Ã  un nouvel utilisateur blogtuto que nous crÃ©ons avec le mot de passe passwd.</p>

<p>Si vous avez dÃ©jÃ  mis en place les sauvegardes MySQL avec le tuto <a href="http://vincent.dauce.fr/administrer-un-serveur-dedie-part-7-backup-mysql/" title="Administrer un serveur dÃ©diÃ© â€“ part 7 : Backup MySQL">Administrer un serveur dÃ©diÃ© â€“ part 7 : Backup MySQL</a>, pensez Ã  rajouter les droits pour la sauvegarde automatique entre le grant initial et le flush privileges :</p>

<p>Ajouter la sauvegarde de la base en automatique:</p>

<pre><code class="language-sql">GRANT SELECT , INSERT , LOCK TABLES ON `blogtutoDB` . * TO 'mysql-backup-manager'@'localhost';
</code></pre>

<h2>Configurer le container avec un nom de domaine</h2>

<p>Une bonne pratique Ã  avoir est de rajouter le nom de domaine dans le fichier host du container. Pour cela vous devez juste rajouter Â« blogtuto.com Â» sur la premiÃ¨re ligne du fichier host aprÃ¨s localhost :</p>

<p>vi /etc/hosts
Vous pouvez rajouter autant de domaines que vous le souhaitez sÃ©parÃ© par des espaces.</p>

<h2>Configurer le virtual host Apache avec un nom de domaine</h2>

<p>La mÃ©thode de userdir est sympathique quand on a pas nom de domaine mais quand on en a un alors il faut configurer Apache pour reconnaÃ®tre ce domaine et rediriger vers la bonne home.</p>

<p>Il faut donc crÃ©er un virtual host (nouveau fichier)</p>

<p>vi /etc/apache2/sites-available/01-blogtuto.com:</p>

<pre><code class="language-bash">&lt;VirtualHost *:80&gt;
        ServerAdmin blogtuto@localhost
        ServerName www.blogtuto.com
        ServerAlias blogtuto.com

        DocumentRoot /home/blogtuto/www
        &lt;Directory /home/blogtuto/www&gt;
                Options None
                AllowOverride None
        &lt;/Directory&gt;

        ErrorLog /home/blogtuto/logs/error.log

        # Possible values include: debug, info, notice, warn, error, crit,
        # alert, emerg.
        LogLevel warn

        CustomLog /home/blogtuto/logs/access.log combined

&lt;/VirtualHost&gt;
</code></pre>

<p>Et pour le coup il y a du travail car beaucoup de configuration Ã  faire et Ã  expliquer.</p>

<p>DÃ©jÃ  le nom du fichier Â« 01-blogtuto.com Â» câ€™est une convention personnel :</p>

<ul>
<li>On commence par 01, puis 02, â€¦ : Les virtual host sont pris dans lâ€™ordre avec Apache donc si plusieurs correspondent câ€™est le premier qui sera pris. Donc on essaye de les classer au mieux.</li>
<li>Ensuite blogtuto.com pour la conf du domaine blogtuto.com câ€™est plus facile Ã  ce souvenir mais câ€™est pas nÃ©cessaire techniquement tous les fichiers sont pris par apache</li>
</ul>

<p>Pour le fichier de conf :</p>

<ul>
<li>VirtualHost *:80 : On peut avoir plusieurs balise dans un fichier mais je prÃ©fÃ¨re en avoir quâ€™un. Ici on dit que ce virtual host Ã©coutera sur le port 80 (http et donc pas https) sur nâ€™importe quâ€™elle IP comme le container en a quâ€™un Ã§Ã  sera toujours la mÃªme mais si vous avez plusieurs IP sur le mÃªme container il faut prÃ©ciser</li>
<li><a href="http://httpd.apache.org/docs/2.2/fr/mod/core.html#ServerAdmin">ServerAdmin</a> : câ€™est lâ€™adresse mail de contact qui recevra les messages dâ€™erreurs donc mon utilisateur blogtuto@localhost</li>
<li><a href="http://httpd.apache.org/docs/2.2/fr/mod/core.html#ServerName">ServerName</a> : La directive la plus importante qui va permettre dâ€™identifier le virtual host Ã  utiliser donc lâ€™adresse la plus importante soit www.blogtuto.com ou blogtuto.com en fonction</li>
<li><a href="http://httpd.apache.org/docs/2.2/fr/mod/core.html#ServerAlias">ServerAlias</a> : La directive alternative donc si vous avez mis www.blogtuto.com mettez blogtuto.com et inversement</li>
<li><a href="http://httpd.apache.org/docs/2.2/fr/mod/core.html#DocumentRoot">DocumentRoot</a> : Indique la racine quand on appel http://www.blogtuto.com/index.html avec DocumentRoot = /home/blogtuto/www, Apache traduit par le fichier /home/blogtuto/www/index.html (Ne pas mettre de slash Ã  la fin)</li>
<li><a href="http://httpd.apache.org/docs/2.2/fr/mod/core.html#Directory">Directory</a> : On va mettre au moins une balise directory avec la mÃªme valeur que DocumentRoot et ensuite on peut rajouter dâ€™autres si nÃ©cessaire. Câ€™est dans cette directive quâ€™on va devoir mettre les configurations applicables pour un dossier/sous-dossier, â€¦ On reviendra plus tard sur les directives intÃ©ressantes Ã  rajouter ou supprimer. On interdit tout pour le moment</li>
<li><a href="http://httpd.apache.org/docs/2.2/fr/mod/core.html#ErrorLog">ErrorLog</a> et CustomLog : pour avoir des logs Apache dans le rÃ©pertoire logs que nous avons crÃ©Ã©. On se place au niveau warn pour recevoir un maximum dâ€™information si on veut diagnostiquer un jour.</li>
</ul>

<p>Pour prendre en compte nos modifications il faut activer le nouveau virtual host et recharger Apache :</p>

<p>Activer un site et recharger Apache:</p>

<pre><code class="language-bash">a2ensite 01-blogtuto.com
service apache2 reload
</code></pre>

<h2>Encore plus loin avec Directory</h2>

<h3>AllowOverride</h3>

<p>Jâ€™ai pris lâ€™habitude de ne jamais autoriser AllowOverride donc le mettre Ã  None pour une question de performance. Cette directive permet dâ€™utiliser les fameux fichier .htaccess qui permette de rÃ©Ã©crire la configuration dâ€™Apache Ã  la volÃ©e. Seulement voilÃ  Ã§a demande des ressources Ã  Apache pour contrÃ´ler lâ€™existence du fichier et modifier la configuration Ã  la volÃ©e. Quand on a accÃ¨s au serveur et que la configuration ne change pas souvent et quâ€™on a pas besoin que lâ€™utilisateur choisisse les rÃ©glages câ€™est lâ€™idÃ©al. Si on a vraiment besoin de cet libertÃ© alors je vous conseil de rajouter une directive trÃ¨s stricte. Je vous invite aussi Ã  lire la doc Apache sur le sujet Â« <a href="http://httpd.apache.org/docs/2.2/fr/howto/htaccess.html#when">Quand doit-on (ne doit-on pas) utiliser les fichiers .htaccess ?</a> Â»</p>

<p>Donc pour rÃ©sumer je nâ€™utilise pas de fichiers htaccess. Toutes les directives que je trouve dans un htaccess je le rajoute dans la configuration de mon virtual host et comme ca je profite du cache dâ€™Apache pour une configuration qui ne change jamais ou presque.</p>

<p>Pour WordPress :</p>

<p>Virtual Host Apache pour WordPress:</p>

<pre><code class="language-bash">&lt;Directory /home/blogtuto/www&gt;
  Options +SymLinksIfOwnerMatch -FollowSymLinks -ExecCGI -Includes -IncludesNOEXEC -Indexes -MultiViews
  AllowOverride None

  # BEGIN WordPress
  RewriteEngine On
  RewriteBase /
  RewriteRule ^index\.php$ - [L]
  RewriteCond %{REQUEST_FILENAME} !-f
  RewriteCond %{REQUEST_FILENAME} !-d
  RewriteRule . /index.php [L]
  # END WordPress
&lt;/Directory&gt;
</code></pre>

<h3>Forcer le WWW ou non</h3>

<p>Il ne faut jamais que vos sites soient accessibles avec 2 URL diffÃ©rentes sinon les statistiques sont faussÃ©s. Donc il faut choisir entre www.blogtuto.com ou blogtuto.com.</p>

<p>Pour rediriger toutes les requÃªtes blogtuto.com vers www.blogtuto.com :</p>

<p>Forcer WWW:</p>

<pre><code class="language-bash">&lt;Directory /home/blogtuto/www&gt;
    Options +SymLinksIfOwnerMatch -FollowSymLinks -ExecCGI -Includes -IncludesNOEXEC -Indexes -MultiViews
    AllowOverride None

    # BEGIN Force WWW
    RewriteEngine On
    RewriteBase /
    RewriteCond %{HTTP_HOST} ^blogtuto.com [NC]
    RewriteRule ^(.*)$ http://www.blogtuto.com/$1 [L,R=301]
    # END Force WWW
&lt;/Directory&gt;
</code></pre>

<p>Et inversement si vous voulez que toutes les requÃªtes www.blogtuto.com redirigent vers blogtuto.com :</p>

<p>Force NO WWW:</p>

<pre><code class="language-bash">&lt;Directory /home/blogtuto/www&gt;
    Options +SymLinksIfOwnerMatch -FollowSymLinks -ExecCGI -Includes -IncludesNOEXEC -Indexes -MultiViews
    AllowOverride None

    # BEGIN Force NO WWW
    RewriteEngine On
    RewriteBase /
    RewriteCond %{HTTP_HOST} !^blogtuto.com [NC]
    RewriteRule ^(.*)$ http://blogtuto.com/$1 [L,R=301]
    # END Force NO WWW
&lt;/Directory&gt;
</code></pre>
    ]]></content>
</entry>
            <entry>
    <id>https://vincent.dauce.fr/blog/2014-02-10-administrer-un-serveur-dedie-part-5-serveur-web</id>
    <link type="text/html" rel="alternate" href="https://vincent.dauce.fr/blog/2014-02-10-administrer-un-serveur-dedie-part-5-serveur-web" />
    <title>Administrer un serveur dÃ©diÃ© - part 5 : Serveur Web</title>
    <published>2014-02-10T00:00:00+00:00</published>
    <updated>2014-02-10T00:00:00+00:00</updated>
    <author>
        <name>Vincent Dauce</name>
    </author>
    <summary type="html">Dans cet article nous allons voir comment dÃ©ployer un serveur web, pour cela nous avons besoin de plusieurs briques :


Apache : câ€™est le serveur web par excellence qui reste encore majoritaire sur le web. Avec lui on va pouvoir servir des pages web......</summary>
    <content type="html"><![CDATA[
        <p>Dans cet article nous allons voir comment dÃ©ployer un serveur web, pour cela nous avons besoin de plusieurs briques :</p>

<ul>
<li>Apache : câ€™est le serveur web par excellence qui reste encore majoritaire sur le web. Avec lui on va pouvoir servir des pages web statiques HTML/CSS</li>
<li>Php : Le langage que jâ€™utilises le plus pour mes sites web.</li>
<li>MySQL : La base de donnÃ©es qui est aussi prÃ©dominante (WordPress, Prestashop, â€¦)</li>
<li>SFTP : je nâ€™utilise pas de serveur FTP car je nâ€™en vois pas lâ€™intÃ©rÃªt quand on a dÃ©jÃ  SSH sur la machine autant activer SFTP.</li>
</ul>

<p>VoilÃ  bien sur on aurait pu prendre Nginx Ã  la place dâ€™Apache, MariaDB Ã  la plase de MySQL, vsFTPd Ã  la place de sftp â€¦ mais il faut faire un choix et on pourra toujours revenir dessus dans un prochain article.</p>

<p>Je vous conseil de rien nâ€™installer sur le host pour le laisser le plus propre possible et dâ€™utiliser un container. Nous souhaitons hÃ©berger nos sites sur CT101 que nous venons de crÃ©er donc câ€™est partit.</p>

<h2>Serveur Web â€“ Apache</h2>

<p>Installer Apache:</p>

<pre><code class="language-bash">aptitude install apache2
</code></pre>

<p>Il va installer plusieurs packages car <a href="https://packages.debian.org/wheezy/apache2">apache2 est un metapaquet</a>.</p>

<p>A la fin de lâ€™installation le serveur web est lancÃ© et fonctionnel. On peut le voir rapidement en saisissant dans votre navigateur lâ€™adresse IP Failover de votre container qui affichera une page web. Avant on avait connexion refusÃ©e.</p>

<p>Il y a aussi aprÃ¨s le lancement un petit warning que nous allons corriger : Â« apache2: Could not reliably determine the serverâ€™s fully qualified domain name, using 127.0.0.1 for ServerName Â»</p>

<p>Câ€™est trÃ¨s simple pour ne plus avoir les erreurs vous devez modifier le fichier suivant et ajouter cette ligne Ã  la fin du fichier :</p>

<p>vi /etc/apache2/apache2.conf:</p>

<pre><code class="language-bash">ServerName localhost
</code></pre>

<p>VÃ©rifions aussi quelques configurations dâ€™Apache pour voir si tout est en ordre :</p>

<p>VÃ©rifier que la configuration dâ€™Apache (normalement câ€™est celle par dÃ©faut) Ã©coute bien sur le port 80. Et aussi sur le port 443 un peu plus bas dans le cas ou on voudrait dÃ©ployer du SSL ce que nous ferons bientÃ´t pour notre cloud.</p>

<p>vi /etc/apache2/ports.conf:</p>

<pre><code class="language-bash">NameVirtualHost *:80
Listen 80
</code></pre>

<p>Modifier en dÃ©commentant la ligne (supprimer le #) pour passer Apache2 en UTF-8 câ€™est la norme sur le web depuis quelques annÃ©es maintenant et vous ne rencontrerez aucun problÃ¨me en encodant tous les fichiers en UTF-8.</p>

<p>vi /etc/apache2/conf.d/charset:</p>

<pre><code class="language-bash">AddDefaultCharset UTF-8
</code></pre>

<p>Pour personnaliser un peu apache je vous conseil 2 modules qui sont presque indispensable pour moi :</p>

<ul>
<li><a href="http://httpd.apache.org/docs/2.2/mod/mod_rewrite.html">rewrite</a> : permet la rÃ©Ã©criture dâ€™URL, tous les sites lâ€™utilisent de nos jours (au lieu dâ€™avoir http://vincent.dauce.fr/index.php?article=1 nous avons http://vincent.dauce.fr/mon-premier-article)</li>
<li><a href="http://httpd.apache.org/docs/current/mod/mod_userdir.html">userdir</a> : celui lÃ  est moins Ã©vident Ã§a permet de crÃ©er un hÃ©bergement web par utilisateur. Pour chaque site hÃ©bergÃ© sur ce serveur je vais crÃ©er un compte avec un mot de passe pour lui donner accÃ¨s aux fichiers et avoir un espace web. Pour sÃ©curiser le tout câ€™est moi qui lâ€™activerait ou non par compte donc par exemple compte root nâ€™a pas dâ€™espace web ğŸ™‚</li>
</ul>

<p>Pour activer les 2 modules ci-dessus nous utilisons :</p>

<p>Activer les modules principaux sur Apache:</p>

<pre><code class="language-bash">a2enmod rewrite
a2enmod userdir
</code></pre>

<p>Comme vu plus haut nous allons sÃ©curiser le module userdir avec la configuration suivante (ajouter les lignes Ã  la fin du fichier aprÃ¨s ServerName) :</p>

<p>vi /etc/apache2/apache2.conf:</p>

<pre><code class="language-bash"># Configuration du module UserDir
UserDir disabled
UserDir /home/*/www
</code></pre>

<p>Le module userdir est ainsi dÃ©sactivÃ© et sera activÃ© au cas par cas selon nos besoins. Et nous dÃ©finissons que les pages web seront dans le rÃ©pertoire /home/*/www avec * le login du compte.</p>

<p>Pour vous donner une idÃ©e, si je veux hÃ©berger le site Â« toto.com Â» je vais crÃ©er un compte toto qui aura donc un rÃ©pertoire personnel dans /home/toto. Si jâ€™active pour ce compte lâ€™espace web il pourra dÃ©poser des fichiers dans /home/toto/www et consultable via le lien CT101_IP_PUBLIC/~toto.</p>

<p>Justement pour Ã©viter dâ€™avoir Ã  crÃ©er Ã  chaque fois le dossier www nous allons automatiser la crÃ©ation et crÃ©er un dossier logs pour stocker les fichier log dâ€™Apache par compte.</p>

<p>Automatiser la crÃ©ation du dossier www:</p>

<pre><code class="language-bash">mkdir /etc/skel/www
mkdir /etc/skel/logs
echo " &lt;strong&gt;Nouvel espace web&lt;/strong&gt; " &gt; /etc/skel/www/index.html
</code></pre>

<p>Puis recharger la configuration et admirer que vous nâ€™avez plus le message dâ€™erreur :</p>

<p>Recharger apache2:</p>

<pre><code class="language-bash">service apache2 reload
</code></pre>

<h2>Serveur SQL â€“ MySQL</h2>

<p>Pour installer MySQL câ€™est trÃ¨s simple voir trop simple ğŸ™‚</p>

<p>Installer MySQL:</p>

<pre><code class="language-bash">aptitude install mysql-server
</code></pre>

<p>On est encore dans le cas dâ€™un metapaquet, on valide et câ€™est tout.</p>

<p>Je vous conseil de choisir un mot de passe complexe pour le root de MySQL, moi jâ€™utilise 50 caractÃ¨res avec majuscules, minuscules et chiffres (Pas de caractÃ¨res spÃ©ciaux car jâ€™ai souvent eu des problÃ¨mes aprÃ¨s pour me connecter avec).</p>

<p>Il existe plein de gÃ©nÃ©rateur de mot de passe en ligne, je vous laisse choisir votre prÃ©fÃ©rÃ© moi jâ€™ai pas trouvÃ©. Surement une idÃ©e dâ€™application Ã  faire ğŸ™‚</p>

<p>VoilÃ  le mien : a4HBSwpwdlF3LafNsPswKM6uZQWGIqrjnUGXkNcoYX3XGE5lZV</p>

<p>Ã  conserver prÃ©cieusement car câ€™est le compte root.</p>

<h2>Serveur App â€“ PHP</h2>

<p>Pour PHP aussi pas beaucoup de chose Ã  faire (PHP 5.4) :</p>

<p>Installer PHP:</p>

<pre><code class="language-bash">aptitude install php5
</code></pre>

<p>AprÃ¨s comme pour Apache il y a des modules plus ou moins importants, voici les principaux :</p>

<ul>
<li><a href="https://packages.debian.org/wheezy/php5-mysql">php5-mysql</a> : plutÃ´t indispensable celui lÃ  sinon comment vous connecter Ã  MySQL que vous venez dâ€™installer ? permet dâ€™activer les fonctions mysql_* (ne plus les utiliser svp câ€™est trop horrible et obsolÃ¨te depuis la version 5.5 de PHP), mysqli_* (câ€™est mieux mais bon) et enfin PDO (Ã§a câ€™est la classe)</li>
<li><a href="https://packages.debian.org/wheezy/php5-curl">php5-curl</a> : pour rÃ©cupÃ©rer des fichiers via HTTP ou FTP</li>
<li><a href="https://packages.debian.org/wheezy/php5-gd">php5-gd</a> : pour traiter des images (resize, traitements, â€¦)</li>
<li><a href="https://packages.debian.org/wheezy/php5-mcrypt">php5-mcrypt</a> : pour crypter des donnÃ©es sensibles</li>
<li><a href="https://packages.debian.org/wheezy/libssh2-php">libssh2-php</a> : pour utiliser SSH dans les scripts PHP</li>
</ul>

<p><a href="http://www.prestashop.com/fr/">Prestashop</a> la boutique en ligne et open source que je vous conseil a besoin de php5-curl pour activer Paypal, php5-gd pour retailler les images, php5-mcrypt pour crypter les donnÃ©es sensibles et bien Ã©videmment php5-mysql.</p>

<p><a href="http://wordpress.org/">WordPress</a> le blog open source qui fait aussi CMS a besoin de libssh2-php pour pouvoir faire les mise Ã  jour en automatique</p>

<p>Pour les installer tous il suffit de lancer :</p>

<p>Installer les modules PHP:</p>

<pre><code class="language-bash">aptitude install php5-mysql php5-gd php5-mcrypt php5-curl libssh2-php
</code></pre>

<p>Juste aprÃ¨s ca vous nâ€™avez rien Ã  faire tout est dÃ©jÃ  fonctionnel.</p>

<h2>Serveur Fichier â€“ SFTP</h2>

<p>Pour le serveur de fichier jâ€™utilisais il y a trÃ¨s longtemps des serveurs FTP plus ou moins sÃ©curisÃ©s jusquâ€™au jour ou jâ€™ai dÃ©couvert que SSH le faisait dÃ©jÃ  trÃ¨s bien. Alors pourquoi installer un nouveau service alors quâ€™on en a dÃ©jÃ  un installÃ© et qui tourne ? en plus il y avait la gestion des comptes qui Ã©tait complexe lÃ  câ€™est le mÃªme login et mot de passe.</p>

<p>Vous allez me dire mais jâ€™ai pas envie de donner un accÃ¨s SSH Ã  mes utilisateurs et bien non on leur donne uniquement le SFTP ils peuvent rien faire de plus câ€™est donc totalement sÃ©curisÃ©.</p>

<p>Pour celÃ  il faut juste configurer SSH pour permettre de rendre le service que lâ€™on veut câ€™est Ã  dire offrir aux utilisateurs un accÃ¨s aux fichiers via un client FTP comme filezilla ou un partage de fichiers.</p>

<p>Il faut donc changer la ligne Â« Subsystem â€¦ Â» (avant on avait Â« Subsystem sftp /usr/lib/openssh/sftp-server Â») : On indique autoriser le faux shell Â« internal-sftp Â» qui va permettre dâ€™interdire lâ€™accÃ¨s au shell pour les utilisateurs.</p>

<p>Et rajouter quelques lignes aprÃ¨s Â« UserPAM yes Â». Pour autoriser le groupe www-data qui est celui dâ€™Apache donc de nos sites.</p>

<ul>
<li>ChrootDirectory : les utilisateurs ne pourront pas remonter Ã  la racine du serveur et explorer notre serveur. Ils sont bloquÃ©s dans leur dossier personnel</li>
<li>X11Forwarding : on nâ€™autorise pas le partage de bureau (application graphique Ã  distance)</li>
<li>AllowTcpForwarding : interdire aussi les tunnels SSH</li>
<li>ForceCommand : pour forcer lâ€™utilisation dâ€™un faux shell et interdire donc un accÃ¨s SSH</li>
</ul>

<p>vi /etc/ssh/sshd_config:</p>

<pre><code class="language-bash">Subsystem sftp internal-sftp

# Set this to 'yes' to enable PAM authentication, account processing,
# and session processing. If this is enabled, PAM authentication will
# be allowed through the ChallengeResponseAuthentication and
# PasswordAuthentication. Depending on your PAM configuration,
# PAM authentication via ChallengeResponseAuthentication may bypass
# the setting of "PermitRootLogin without-password".
# If you just want the PAM account and session checks to run without
# PAM authentication, then enable this but set PasswordAuthentication
# and ChallengeResponseAuthentication to 'no'.
UsePAM yes
    AllowGroups www-data
    Match Group www-data
            ChrootDirectory /home/%u
            X11Forwarding no
            AllowTcpForwarding no
            ForceCommand internal-sftp
</code></pre>

<p>Reste Ã  recharger la configuration de notre service :</p>

<p>Recharger SSH:</p>

<pre><code class="language-bash">service ssh reload
</code></pre>

<p>Et voilÃ  nous avons un SFTP sÃ©curisÃ© accessible uniquement aux utilisateurs appartenant au groupe www-data. Pour rappel le fichier de conf a dÃ©jÃ  Ã©tÃ© modifiÃ© pour interdire au root de pouvoir se connecter et nous avons dÃ©jÃ  changÃ© le port par dÃ©faut qui Ã©tait Ã  22 pour plus de sÃ©curitÃ©.</p>

<p>Reste Ã  rajouter des droits car sinon le SFTP interdira de se connecter.</p>

<p>Droits pour SFTP:</p>

<pre><code class="language-bash">chown -R root:www-data /home/
chmod -R 750 /home/
</code></pre>
    ]]></content>
</entry>
            <entry>
    <id>https://vincent.dauce.fr/blog/2014-02-01-administrer-un-serveur-dedie-part-4-premier-container</id>
    <link type="text/html" rel="alternate" href="https://vincent.dauce.fr/blog/2014-02-01-administrer-un-serveur-dedie-part-4-premier-container" />
    <title>Administrer un serveur dÃ©diÃ© - part 4 : Premier container</title>
    <published>2014-02-01T00:00:00+00:00</published>
    <updated>2014-02-01T00:00:00+00:00</updated>
    <author>
        <name>Vincent Dauce</name>
    </author>
    <summary type="html">AprÃ¨s dÃ©jÃ  3 articles, nous arrivons enfin Ã  notre premier container qui va nous permettre enfin dâ€™hÃ©berger nos sites et rendre service, car câ€™est bien lÃ  le but dâ€™un serveur rendre services aux autres.



CrÃ©er un container



Et voilÃ ......</summary>
    <content type="html"><![CDATA[
        <p>AprÃ¨s dÃ©jÃ  3 articles, nous arrivons enfin Ã  notre premier container qui va nous permettre enfin dâ€™hÃ©berger nos sites et rendre service, car câ€™est bien lÃ  le but dâ€™un serveur rendre services aux autres.</p>

<h2>CrÃ©er le container</h2>

<p>CrÃ©er un container</p>

<pre><code class="language-bash">lxc-create -n CT101 -t debian
</code></pre>

<p>Et voilÃ  câ€™est fait, vous avez une Debian 7.4 Ã  jour ğŸ™‚ le mot de passe est root par dÃ©faut on le changera rapidement.</p>

<p>Le nom de votre container câ€™est CT101 quâ€™on devra utiliser dans presque toutes les commandes de LXC.</p>

<p>â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”</p>

<p>25/05/2014 : Modification du masque rÃ©seau (/24 au lieu de rien avant)</p>

<p>â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”</p>

<p>AprÃ¨s lâ€™installation le container est Ã  lâ€™arrÃªt donc dÃ©marrons le :</p>

<p>DÃ©marrer un container:</p>

<pre><code class="language-bash">ln -s /var/lib/lxc/CT101/config /etc/lxc/auto/CT101
lxc-start -n CT101 -d
</code></pre>

<p>La premiÃ¨re permet de dÃ©marrer automatiquement le container Ã  chaque fois que le host dÃ©marre. Et la seconde est pour le dÃ©marrer maintenant car on veut faire mumuse avec ğŸ™‚</p>

<p>Nous allons nous connecter dessus pour commencer Ã  lâ€™utiliser</p>

<p>Se connecter Ã  la console du container CT101:</p>

<pre><code class="language-bash">lxc-console -n CT101
</code></pre>

<p>Quand on tape cette commande la phrase Â« Type &lt;Ctrl+a q&gt; to exit the console, &lt;Ctrl+a Ctrl+a&gt; to enter Ctrl+a itself Â» sâ€™affiche.</p>

<p>Donc avec notre clavier on fait Ctrl+a puis EntrÃ©e pour voir apparaÃ®tre le prompt du login et pouvoir saisir root (le mot de passe est par dÃ©faut root).</p>

<p>A ce moment lÃ  vous Ãªtes connectÃ© Ã  votre container, vous pouvez le voir car le prompt a changÃ© Â« root@CT101:~# Â»</p>

<p>Pour quitter le container et revenir au prompt du host il suffit de faire exit. On revient Ã  ce moment lÃ  au prompt du login et on a plus quâ€™Ã  saisir Ctrl+a puis q.</p>

<p>Le prompt change de nouveau pour nous indiquer que nous sommes sur le host.</p>

<p>La suite est dÃ©jÃ  expliquÃ© dans mon article <a href="http://vincent.dauce.fr/administrer-un-serveur-dedie-part-2-le-socle/" title="Administrer un serveur dÃ©diÃ© â€“ part 2 : Le socle">Administrer un serveur dÃ©diÃ© â€“ part 2 : Le socle</a> (Section : PremiÃ¨res actions et SÃ©curiser le service SSH)</p>

<h2>Configurer le rÃ©seau sur le host</h2>

<p>On va commander un IP Failover sur la console Online, sur la page <a href="https://console.online.net/fr/server/failover">Failover</a>, cliquer sur le bouton Â« Commander des adresses IP Â», sÃ©lectionner celle que vous voulez en fonction de la beautÃ© des chiffres ğŸ™‚ et valider avec le bouton Â« Commander dâ€™IP Failover Â»</p>

<p>AprÃ¨s la commande on retour sur la page <a href="https://console.online.net/fr/server/failover">Failover</a> pour cette fois assigner lâ€™IP Ã  un serveur. Les IP disponibles sont en vert dans la liste des IP Failovers. Il suffit de glisser-dÃ©poser lâ€™IP quâ€™on vient dâ€™acheter sur le serveur que lâ€™on souhaite. Et cliquer sur le bouton Â« Mise Ã  jour Â». Un rÃ©capitulatif des modifications sâ€™affichent puis cliquer sur le bouton Â« Mise Ã  jour Â».</p>

<p>Ma nouvelle adresse IP Failover est : CT101_IP_PUBLIC</p>

<p>Dans la configuration rÃ©seau que nous allons faire nous nâ€™avons pas besoin dâ€™assigner une adresse mac Ã  notre IP car lâ€™IP bien que publique nâ€™est pas connectÃ© en direct mais passe par du NAT.</p>

<p>On va configurer le rÃ©seau Ã  partir du host donc dÃ©connectez vous du container pour suivre les actions ci-dessous.</p>

<p>On va commencer par dÃ©clarer notre IP en tant quâ€™interface rÃ©seau virtuelle sur notre host. Ces quelques lignes sont Ã  rajouter Ã  la fin du fichier aprÃ¨s le bridge que nous avons crÃ©Ã© dans lâ€™article <a href="http://vincent.dauce.fr/administrer-un-serveur-dedie-part-3-virtualisation/" title="Administrer un serveur dÃ©diÃ© â€“ part 3 : Virtualisation">Administrer un serveur dÃ©diÃ© â€“ part 3 : Virtualisation</a></p>

<p>vi /etc/network/interfaces:</p>

<pre><code class="language-bash"># Failover CT101 : CT101_IP_PUBLIC
auto eth0:x
iface eth0:x inet static
        address CT101_IP_PUBLIC
        netmask 255.255.255.255
</code></pre>

<p>Il faut incrÃ©menter le numÃ©ro x Ã  chaque nouvelle IP. Donc eth0 est mon interface principale avec mon lâ€™IP publique de mon serveur, eth0:0 sera lâ€™interface virtuelle de ma premiÃ¨re IP Failover CT101_IP_PUBLIC, eth0:1 sera lâ€™interface virtuelle de ma seconde IP Failover CT102_IP_PUBLIC, eth0:2 sera lâ€™interface virtuelle de ma troisiÃ¨me IP Failover CT103_IP_PUBLIC, â€¦ enfin on est limitÃ© Ã  5 par serveur chez Online.</p>

<p>Le netmask est Ã  255.255.255.255 comme lâ€™indique Online dans sa <a href="http://documentation.online.net/fr/serveur-dedie/reseau/ip-failover">documentation sur lâ€™IP Failover</a>.</p>

<p>Malheureusement cette configuration ne sera prise en compte quâ€™au prochain reboot, donc pour activer notre nouvelle interface maintenant tout de suite on exÃ©cute la commande suivante :</p>

<p>Activer l'IP failover en live:</p>

<pre><code class="language-bash">ifconfig eth0:x CT101_IP_PUBLIC netmask 255.255.255.255
</code></pre>

<h2>Configurer le rÃ©seau sur le container</h2>

<p>On reste sur le host pour configurer le rÃ©seau du container câ€™est plus simple car on est dÃ©jÃ  dessus. Mais câ€™est possible de le faire aussi en Ã©tant connectÃ© sur le container.</p>

<p>Il sâ€™agit donc ici de dÃ©finir un rÃ©seau local entre notre container et le bridge.</p>

<p>Le fichier existe dÃ©jÃ  avec lâ€™interface local et lâ€™interface eth0 que lâ€™on va remplacer.</p>

<p>Nos modifications sont les suivantes :</p>

<ul>
<li>On ne touche pas Ã  la boucle local</li>
<li>Lâ€™interface principale passe en mode manuel (dhcp vers static), câ€™est Ã  dire quâ€™on va spÃ©cifier les informations au lieu de laisser les serveurs DHCP faire le boulot

<ul>
<li>address : IP privÃ©e de notre container (jâ€™utilise toujours 192.168.0.xxx avec xxx le mÃªme numÃ©ro que le nom de mon container donc CT101 est sur lâ€™IP privÃ©e 192.168.0.101 câ€™est plus facile Ã  retenir). Il faut rajouter le masque rÃ©seau /24 indiquant que la boucle local est sur le dernier chiffre de lâ€™IP (ou alors /16 pour indiquer que câ€™est les 2 derniers chiffres Ã  prendre en compte)</li>
<li>broadcast : La mÃªme que ci-dessus avec un 255 Ã  la fin</li>
<li>gateway : Câ€™est lâ€™IP privÃ©e de mon bridge que nous avons dÃ©finit dans lâ€™article prÃ©cÃ©dent (address sur lâ€™interface br0)</li>
</ul></li>
</ul>

<p>vi /var/lib/lxc/CT101/rootfs/etc/network/interfaces:</p>

<pre><code class="language-bash">auto lo
iface lo inet loopback

auto eth0
iface eth0 inet static
        address 192.168.0.101
        netmask 255.255.255.0
        broadcast 192.168.0.255
        gateway 192.168.0.1
</code></pre>

<p>Il y a aussi le fichier de configuration LXC pour le container en question Ã  modifier. Le fichier permet de configurer des tas de choses mais nous allons nous concentrer uniquement sur le rÃ©seau. Normalement les directives ci-dessous nâ€™existent pas donc ajouter les Ã  la fin du fichier :</p>

<p>vi /var/lib/lxc/CT101/config:</p>

<pre><code class="language-bash"># Network
lxc.network.type = veth
lxc.network.flags = up
lxc.network.link = br0
lxc.network.name = eth0
lxc.network.ipv4 = 192.168.0.101/24
lxc.network.veth.pair = vethCT101
</code></pre>

<p>On indique Ã  LXC comment traiter le rÃ©seau de notre container :</p>

<ul>
<li>lxc.network.type : lxc permet dâ€™avoir diffÃ©rent types de rÃ©seaux (phys, vlan, â€¦) nous on a choisir veth câ€™est Ã  dire lâ€™utilisation dâ€™un bridge que nous lui indiquerons dans la directive lxc.network.link</li>
<li>lxc.network.flags : On le met Ã  Â« up Â» pour activer le rÃ©seau</li>
<li>lxc.network.link : on vient de dire Ã  LXC de traiter le rÃ©seau avec un bridge on lui indique ici le nom de lâ€™interface que nous avons mis dans /etc/network/interface du host</li>
<li>lxc.network.name : on utilise lâ€™interface eth0 de notre container, celle que nous venons de configurer ci-dessus avec lâ€™IP 192.168.0.101</li>
<li>lxc.network.ipv4 : cette fois câ€™est notre IP privÃ©e</li>
<li>lxc.network.veth.pair : câ€™est le nom que nous donnons au lien, cf lâ€™image de notre rÃ©seau dans lâ€™article prÃ©cÃ©dent</li>
</ul>

<h2>Configurer le firewall</h2>

<p>Maintenant que notre rÃ©seau est configurÃ© nous allons devoir faire quelques mises Ã  jours sur notre firewall :</p>

<ul>
<li>NAT : câ€™est Ã  dire transformer tous les flux qui sortent de notre container avec lâ€™IP 192.168.0.101 par CT101_IP_PUBLIC et inversement</li>
<li>Autoriser les flux en fonction des services que lâ€™on proposera dans notre container</li>
</ul>

<p>Modifier le firewall que nous avons mis en place dans <a href="http://vincent.dauce.fr/administrer-un-serveur-dedie-part-2-le-socle/" title="Administrer un serveur dÃ©diÃ© â€“ part 2 : Le socle">Administrer un serveur dÃ©diÃ© â€“ part 2 : Le socle</a> (Mise en place dâ€™un firewall)</p>

<p>Pour rajouter les 2 lignes suivantes : dÃ©claration de lâ€™IP publique et privÃ©e de notre container CT101.</p>

<p>vi /etc/init.d/firewall.sh:</p>

<pre><code class="language-bash">HN_IP="xx.xx.xx.xx"

CT101_IP_PRIVATE="192.168.0.101"
CT101_IP_PUBLIC="CT101_IP_PUBLIC"

##########################
# Start the Firewall rules
##########################
</code></pre>

<p>Et et un peu plus loin entre le bloc Â« Autoriser HTTP et HTTPS Â» et la fin du bloc fw_start() :</p>

<p>vi /etc/init.d/firewall.sh:</p>

<pre><code class="language-bash"># Autoriser HTTP et HTTPS
iptables -t filter -A OUTPUT -p tcp --dport $HTTP_PORT -j ACCEPT
iptables -t filter -A INPUT -p tcp --dport $HTTP_PORT -j ACCEPT
iptables -t filter -A OUTPUT -p tcp --dport $HTTPS_PORT -j ACCEPT
iptables -t filter -A INPUT -p tcp --dport $HTTPS_PORT -j ACCEPT

# CT101 : Configuration NAT
iptables -A FORWARD -s $CT101_IP_PRIVATE -j ACCEPT
iptables -A FORWARD -d $CT101_IP_PRIVATE -j ACCEPT
iptables -t nat -A POSTROUTING -s $CT101_IP_PRIVATE -j SNAT --to $CT101_IP_PUBLIC
# CT101 : Autoriser HTTP
iptables -t nat -I PREROUTING -p tcp -d $CT101_IP_PUBLIC --dport $HTTP_PORT -j DNAT --to $CT101_IP_PRIVATE
iptables -I FORWARD -p tcp -d $CT101_IP_PRIVATE --dport $HTTP_PORT
# CT101 : Autoriser SSH
iptables -t nat -I PREROUTING -p tcp -d $CT101_IP_PUBLIC --dport $SSH_PORT -j DNAT --to $CT101_IP_PRIVATE
iptables -I FORWARD -p tcp -d $CT101_IP_PRIVATE --dport $SSH_PORT

}
fw_stop(){
</code></pre>

<p>Il reste Ã  relancer le firewall pour prise en compte des nouvelles rÃ¨gles :</p>

<p>Relancer le firewall:</p>

<pre><code class="language-bash">firewall.sh restart
</code></pre>

<p>Et relancer le container pour prendre en compte les changements rÃ©seaux et de configuration LXC :</p>

<p>Relancer le container:</p>

<pre><code class="language-bash">lxc-stop -n CT101
lxc-list
lxc-start -n CT101 -d
</code></pre>

<p>Et voilÃ , vous avez un container qui a accÃ¨s Ã  internet et qui peut hÃ©berger un serveur web par exemple ğŸ™‚</p>

<p>Ha on me dit que câ€™est dans le prochain article donc je vous laisse.</p>

<p>Vous pouvez rÃ©pÃ©ter ce tuto autant de fois que vous voulez de container.</p>
    ]]></content>
</entry>
            <entry>
    <id>https://vincent.dauce.fr/blog/2014-01-25-administrer-un-serveur-dedie-part-3-virtualisation</id>
    <link type="text/html" rel="alternate" href="https://vincent.dauce.fr/blog/2014-01-25-administrer-un-serveur-dedie-part-3-virtualisation" />
    <title>Administrer un serveur dÃ©diÃ© - part 3 : Virtualisation</title>
    <published>2014-01-25T00:00:00+00:00</published>
    <updated>2014-01-25T00:00:00+00:00</updated>
    <author>
        <name>Vincent Dauce</name>
    </author>
    <summary type="html">On va passer Ã  la virtualisation, câ€™est Ã  la mode et câ€™est super efficace. Lâ€™objectif est dâ€™avoir avec un serveur plusieurs serveurs.

Avant jâ€™utilisais la solution OpenVZ mais depuis Debian Wheezy la solution prÃ©conisÃ©e est LXC mÃªme si......</summary>
    <content type="html"><![CDATA[
        <p>On va passer Ã  la virtualisation, câ€™est Ã  la mode et câ€™est super efficace. Lâ€™objectif est dâ€™avoir avec un serveur plusieurs serveurs.</p>

<p>Avant jâ€™utilisais la solution OpenVZ mais depuis Debian Wheezy la solution prÃ©conisÃ©e est LXC mÃªme si elle ne semble pas encore trÃ¨s mature elle fonctionne parfaitement.</p>

<p>Les avantages de LXC par rapport Ã  OpenVZ câ€™est :</p>

<ul>
<li>Le noyau qui est Â« mainline Â» donc pas besoin de le patcher comme pour OpenVZ, câ€™est juste un package Debian comme les autres</li>
<li>Câ€™est forcÃ©ment le future, bien que pas totalement mature pour le moment il va devenir une rÃ©fÃ©rence plus tard</li>
<li>OpenVZ mÃªme si il est gratuit est maintenu par une sociÃ©tÃ© Parallels qui vent des solutions de virtualisation</li>
</ul>

<p>Voici donc lâ€™architecture quâ€™on va mettre en place :</p>

<ul>
<li>On va installer LXC sur notre serveur (host)</li>
<li>On va crÃ©er plusieurs containers (ie serveurs) pour diffÃ©rents usages:

<ul>
<li>CT101 : Container pour hÃ©berger les sites internet en production</li>
<li>CT102 : Container pour hÃ©berger mes sites personnels (ma vie privÃ©e)</li>
<li>CT103 : Container pour hÃ©berger mes sites en dÃ©veloppements</li>
</ul></li>
</ul>

<p>On va devoir configurer un rÃ©seau pour que notre host redirige les flux entrants et sortants vers le bon container. Pour cela on va sâ€™appuyer sur des IP Failover que propose Online. Ces IP que tu loues Ã  lâ€™unitÃ© vont te permettre de faire croire au monde entier que tu as plusieurs serveurs.</p>

<p>Le host aura 2 IP, une IP publique HN&#95;IP et une privÃ©e 192.168.0.1 pour dialoguer avec les autres containers</p>

<p>Le CT101 aura aussi 2 IP, une IP publique (failover) CT101&#95;IP&#95;PUBLIC et une privÃ©e 192.168.0.101.</p>

<p>MÃªme chose pour CT102, CT103, â€¦.</p>

<h2>Installation de LXC</h2>

<p>Câ€™est trÃ¨s facile il suffit de lancer la commande et on demandera uniquement de valider le rÃ©pertoire. On va laisser celui par dÃ©faut câ€™est Ã  dire /var/lib/lxc</p>

<p>Installer LXC:</p>

<pre><code class="language-bash">aptitude install lxc bridge-utils libvirt-bin debootstrap
</code></pre>

<p>LXC a besoin de <a href="http://fr.wikipedia.org/wiki/Cgroups">cgroups</a> pour limiter les ressources du serveur sur chaque container donc on va lâ€™activer :</p>

<p>Activer cgroups:</p>

<pre><code class="language-bash">echo "cgroup /sys/fs/cgroup cgroup defaults 0 0" &gt;&gt; /etc/fstab
mount /sys/fs/cgroup
</code></pre>

<p>La premiÃ¨re ligne permet de lâ€™activer par dÃ©faut au dÃ©marrage du serveur et la seconde permet de lâ€™activer maintenant.</p>

<p>Enfin il faut vÃ©rifier que lâ€™installation de LXC est bonne et vÃ©rifier le rÃ©sultat de la commande checkconfig</p>

<p>VÃ©rifier l'installation de LXC:</p>

<pre><code class="language-bash">lxc-checkconfig
</code></pre>

<h2>Modification du rÃ©seau</h2>

<p>Surement la partie la plus dure car il y a plusieurs mÃ©thodes possible.</p>

<p>AprÃ¨s lâ€™installation dâ€™une Debian vous devriez avoir le rÃ©seau configurÃ© de cette maniÃ¨re :</p>

<p>RÃ©seau par dÃ©faut:</p>

<pre><code class="language-bash"># The loopback network interface
auto lo
iface lo inet loopback

# The primary network interface
allow-hotplug eth0
iface eth0 inet dhcp
</code></pre>

<p>A modifier par :</p>

<p>vi /etc/network/interfaces:</p>

<pre><code class="language-bash"># The loopback network interface
auto lo
iface lo inet loopback

# The primary network interface
auto eth0
iface eth0 inet static
       address xx.xx.xx.xx
       netmask 255.255.255.0
       network xx.xx.xx.0
       broadcast xx.xx.xx.255
       gateway xx.xx.xx.1
       post-up echo 1 &gt; /proc/sys/net/ipv4/ip_forward

# The bridge network interface
auto br0
iface br0 inet static
       address 192.168.0.1
       netmask 255.255.255.0
       bridge_ports none
       bridge_stp off
       bridge_fd 0
       bridge_maxwait 5 
</code></pre>

<p>Une petite explication sâ€™impose avant on avait un rÃ©seau avec 2 interfaces :</p>

<ul>
<li>La boucle local pour que le serveur se parle Ã  lui mÃªme (localhost)</li>
<li>Lâ€™interface principal avec notre IP publique que nous rÃ©cupÃ©rons directement des serveurs DHCP dâ€™Online.</li>
</ul>

<p>Nos modifications sont les suivantes :</p>

<ul>
<li>On ne touche pas Ã  la boucle local</li>
<li>Lâ€™interface principale passe en mode manuel (dhcp vers static), câ€™est Ã  dire quâ€™on va spÃ©cifier les informations au lieu de laisser les serveurs DHCP faire le boulot

<ul>
<li>address : IP publique de votre serveur (disponible sur le panel Online)</li>
<li>network : La mÃªme que ci-dessus avec un 0 Ã  la fin</li>
<li>broadcast : La mÃªme que ci-dessus avec un 255 Ã  la fin cette fois</li>
<li>gateway : La mÃªme que ci-dessus avec un 1 Ã  la fin cette fois</li>
<li>ip_forward : permet dâ€™activer lâ€™IP Forwarding ca va nous servir pour nos containers</li>
</ul></li>
<li>On rajoute une interface bridge, en gros un switch sur lequel on va connecter les autres containers.

<ul>
<li>address : câ€™est lâ€™IP privÃ©e de notre host</li>
</ul></li>
</ul>

<p><a href="http://vincent.dauce.fr/wp-content/uploads/2014/02/lxc-veth.png"><img src="http://vincent.dauce.fr/wp-content/uploads/2014/02/lxc-veth-300x167.png" alt="lxc-veth" /></a></p>

<p>Pour le moment nous avons mis en place que lâ€™interface eth0 et br0 sur le host. Nous verrons dans un prochain article lâ€™interface vethCT101 connectÃ© avec lâ€™interface eth0 du container en question.</p>

<p>Un trÃ¨s bon tuto de Albin Kauffman (dâ€™oÃ¹ jâ€™ai repris lâ€™image en lâ€™adaptant Ã  ma terminologie) :</p>

<p><a href="http://www.linuxembedded.fr/2013/07/configuration-reseau-de-lxc/">http://www.linuxembedded.fr/2013/07/configuration-reseau-de-lxc/</a></p>

<p>Merci Ã  lui.</p>

<h2>Quelques commandes avec LXC</h2>

<p>Lister les containers:</p>

<pre><code class="language-bash">lxc-list
</code></pre>

<p>DÃ©marrer le container CT101:</p>

<pre><code class="language-bash">lxc-start -n CT101 -d
</code></pre>

<p>Se connecter sur le container CT101:</p>

<pre><code class="language-bash">lxc-console -n CT101
</code></pre>

<p>Il y a visiblement plusieurs mÃ©thodes (Â« lxc-halt -n CT101 Â» ou Â« lxc-stop -n CT101 Â») pour arrÃªter un container mais elles ne sont pas dÃ¨s plus douces. La solution la plus propre consiste Ã  se connecter dessus Ã  lâ€™arrÃªter puis Ã  dire Ã  LXC de la stopper.</p>

<p>ArrÃªter le container CT101:</p>

<pre><code class="language-bash">#HOST&gt; lxc-console -n CT101
#CT101&gt; init 0
#HOST&gt; lxc-stop -n CT101
</code></pre>

<p>Supprimer le container CT101:</p>

<pre><code class="language-bash">lxc-destroy -n CT101
</code></pre>
    ]]></content>
</entry>
            <entry>
    <id>https://vincent.dauce.fr/blog/2014-01-20-administrer-un-serveur-dedie-part-2-le-socle</id>
    <link type="text/html" rel="alternate" href="https://vincent.dauce.fr/blog/2014-01-20-administrer-un-serveur-dedie-part-2-le-socle" />
    <title>Administrer un serveur dÃ©diÃ© - part 2 : Le socle</title>
    <published>2014-01-20T00:00:00+00:00</published>
    <updated>2014-01-20T00:00:00+00:00</updated>
    <author>
        <name>Vincent Dauce</name>
    </author>
    <summary type="html">AprÃ¨s cette petite introduction, nous allons rÃ©ellement commencer lâ€™installation.



On va dans cet article voir comment utiliser lâ€™interface Online qui est trÃ¨s intuitive donc vous devriez pas avoir besoin de moi. Puis configurer la Debian pour......</summary>
    <content type="html"><![CDATA[
        <p>AprÃ¨s cette petite introduction, nous allons rÃ©ellement commencer lâ€™installation.</p>

<h2>Mes choix</h2>

<p>On va dans cet article voir comment utiliser lâ€™interface Online qui est trÃ¨s intuitive donc vous devriez pas avoir besoin de moi. Puis configurer la Debian pour la sÃ©curiser un peu avant de lâ€™utiliser plus que Ã§a.</p>

<p>Pourquoi une Debian ? car jâ€™ai toujours aimÃ© cette distribution qui est trÃ¨s stable, qui est la maman de beaucoup dâ€™autres distribution avec une philosophie trÃ¨s apprÃ©ciable ( non commerciale, collaborative et qui sort pas tous les 6 mois mais quand elle est prÃªte). Donc un trÃ¨s bon choix pour un serveur qui se doit dâ€™Ãªtre sÃ©curisÃ© avec des mises Ã  jours de sÃ©curitÃ© trÃ¨s rÃ©guliÃ¨res.</p>

<p>â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”</p>

<p>27/04/2014 : Ajout de lâ€™expiration du mot de passe au bout de 100 jours pour plus de sÃ©curitÃ© (cmd chage)</p>

<p>22/06/2014 : Coquille sur update-rc.d qui prend uniquement le nom du fichier en paramÃ¨tre et pas le chemin qui est toujours /etc/init.d</p>

<p>â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”</p>

<h2>Installation du serveur via la panel Online</h2>

<p>Tout dâ€™abord il faut se connecter Ã  lâ€™interface qui est dâ€™ailleurs super bien faite contrairement Ã  celle dâ€™OVH je trouve.</p>

<p><a href="https://console.online.net">https://console.online.net</a></p>

<p>Dans le menu <strong>Serveur &gt; Liste de vos serveurs</strong> choisir celui que vous venez de commander et cliquer dessus.</p>

<p>Cliquer sur le bouton <strong>Installer</strong> Ã  droite dans le menu.</p>

<p>Choisir <strong>Distributions serveur &gt; Debian 7 64 bits</strong></p>

<p>Laisser le <strong>partitionnement par dÃ©faut</strong>, nous serons donc en RAID1 soit une bonne sÃ©curitÃ© car 2 disques durs et les donnÃ©es sont en double. Si un disque dur lÃ¢che, Online se charge de le changer et comme Ã§a aucune perte de donnÃ©es et encore moins dâ€™interruption de service.</p>

<p>On conserve le nom de la machine Online, on <strong>choisit un mot de passe pour le root</strong> et un mot de passe pour un compte utilisateur. Pas dâ€™inquiÃ©tude on le changera tout Ã  lâ€™heure.</p>

<p>Puis valider les derniÃ¨res Ã©tapes et <strong>attendre 1h que lâ€™installation se termine</strong> correctement avant de vous connecter dessus pour la premiÃ¨re fois sur votre nouveau serveur dÃ©diÃ©.</p>

<h2>PremiÃ¨re actions</h2>

<p>Comme je le disais prÃ©cÃ©demment on va commencer par changer les mots de passe car on ne sait jamais le mot de passe quâ€™on a mit la premiÃ¨re fois câ€™Ã©tait sur internet donc câ€™est pas sÃ»r. Commande Ã  utiliser pour le compte root et le compte utilisateur crÃ©Ã© prÃ©cÃ©demment. On rajoute une expiration du mot de passe Ã  100 jours pour amÃ©liorer la sÃ©curitÃ©.</p>

<p>Mettre Ã  jour les mots de passe:</p>

<pre><code class="language-bash">passwd root
chage -M 100 root
</code></pre>

<p>Ensuite on passe Ã  la mise Ã  jour de notre Debian, comme il y en a rÃ©guliÃ¨rement il faut le faire. On verra plus tard comment lâ€™automatiser. Par la mÃªme occasion vous remarquez quâ€™on utilise toujours Â« aptitude Â» au lieu Â« apt-get Â» pour la gestion des paquets sous Debian car câ€™est celui qui est <a href="http://www.debian.org/doc/manuals/debian-faq/ch-pkgtools.fr.html#s-aptitude">recommandÃ©</a>. (Si aptitude nâ€™est pas installÃ© il suffit de faire Â« apt-get install aptitude Â»)</p>

<p>PremiÃ¨re mise Ã  jour:</p>

<pre><code class="language-bash">aptitude update
aptitude upgrade
</code></pre>

<p>Jâ€™ai pris lâ€™habitude de supprimer les services inutiles pour mes besoins car si on a moins de service alors on a plus de performance et moins de faille de sÃ©curitÃ©.</p>

<p>Pour le moment la liste se compose de :</p>

<ul>
<li>telnet (protocole de communication assez ancien que je nâ€™utilise pas)</li>
<li>exim4 (agent de transport de courrier mais pas necessaire dans mon cas)</li>
</ul>

<p>Supprimer les services inutiles:</p>

<pre><code class="language-bash">aptitude remove telnet
service exim4 stop
update-rc.d -f exim4 remove
rm /etc/init.d/exim4
aptitude purge exim4
</code></pre>

<h2>SÃ©curiser le service SSH</h2>

<p>Le service SSH est la premiÃ¨re cible des attaques et le seul accÃ¨s Ã  votre serveur donc il faut le sÃ©curiser un maximum pour Ã©viter de se faire attaquer.</p>

<p>Si vous me croyez pas il suffit dâ€™aller voir les logs aprÃ¨s lâ€™installation de votre serveur dans /var/log/auth.log.</p>

<p>On change le port par dÃ©faut car la plupart des robots utilise 22 pour essayer des milliards de login et password. On interdit au root de se connecter en SSH, ca veut dire quâ€™on sera toujours obligÃ© de se connecter avec un compte utilisateur puis le compte root et on autorise au cas par cas les comptes. Ã‡a permet dâ€™Ã©viter les robots qui utilisent root comme login. Les 2 derniÃ¨res directives sont normalement dÃ©jÃ  en place sur Debian 7.</p>

<p>vi /etc/ssh/sshd_config:</p>

<pre><code class="language-bash">Port xxxx (le modifier pour ne pas utiliser le port par dÃ©faut 22)
PermitRootLogin no
AllowUsers monlogin
PermitEmptyPasswords no
Protocol 2
</code></pre>

<p>Puis on relance le service pour prendre en compte la nouvelle configuration. Comme nous nâ€™avons pas encore mis en place un firewall vous devriez pouvoir encore vous connecter dessus ğŸ™‚</p>

<p>Relancer le service SSH:</p>

<pre><code class="language-bash">service ssh reload
</code></pre>

<h2>Mise en place dâ€™un firewall</h2>

<p>Un firewall permet de contrÃ´ler les flux rÃ©seaux entrants et sortants de votre serveur. Il est primordial dâ€™en avoir un et quâ€™il soit le plus restrictif possible, si votre machine hÃ©berge uniquement un serveur web alors on autorise uniquement le HTTP, â€¦.</p>

<p>La mise en place est assez simple on va Ã©crire un script qui sera exÃ©cutÃ© Ã  chaque dÃ©marrage du serveur et qui va inscrire les rÃ¨gles que lâ€™on souhaite grÃ¢ce Ã  un logiciel bien connu dans le monde linux: iptables</p>

<p>Il suffit juste de mettre votre IP au niveau de la variable HN_IP et de bien prÃ©ciser le port SSH (le mÃªme que celui au dessus) dans la variable SSH_PORT:</p>

<pre><code class="language-bash">#!/bin/sh
#
# Simple Firewall configuration.
#
# Author: eXorus
#
# chkconfig: 2345 9 91
# description: Activates/Deactivates the firewall at boot time
#
### BEGIN INIT INFO
# Provides:          firewall.sh
# Required-Start:    $syslog $network
# Required-Stop:     $syslog $network
# Default-Start:     2 3 4 5
# Default-Stop:      0 1 6
# Short-Description: Start firewall daemon at boot time
# Description:       Custom Firewall script
### END INIT INFO

##########################
# Configuration
##########################

SSH_PORT="xxxx"
FTP_PORT="21"
DNS_PORT="53"
MAIL_PORT="25"
NTP_PORT="123"
HTTP_PORT="80"
HTTPS_PORT="443"

HN_IP="xx.xx.xx.xx"


##########################
# Start the Firewall rules
##########################

fw_start(){
        # Ne pas casser les connexions etablies
        iptables -A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT
        iptables -A OUTPUT -m state --state RELATED,ESTABLISHED -j ACCEPT

        # Autoriser loopback
        iptables -t filter      -A INPUT        -i lo -s 127.0.0.0/8 -d 127.0.0.0/8 -j ACCEPT
        iptables -t filter      -A OUTPUT       -o lo -s 127.0.0.0/8 -d 127.0.0.0/8 -j ACCEPT

        # Autoriser le ping
        iptables -t filter      -A INPUT        -p icmp -j ACCEPT
        iptables -t filter      -A OUTPUT       -p icmp -j ACCEPT

        # Autoriser SSH
        iptables -t filter      -A INPUT        -p tcp --dport $SSH_PORT -j ACCEPT
        iptables -t filter      -A OUTPUT       -p tcp --dport $SSH_PORT -j ACCEPT

        # Autoriser NTP
        iptables -t filter      -A OUTPUT       -p udp --dport $NTP_PORT -j ACCEPT

        # Autoriser DNS
        iptables -t filter -A OUTPUT -p tcp --dport $DNS_PORT -j ACCEPT
        iptables -t filter -A OUTPUT -p udp --dport $DNS_PORT -j ACCEPT
        iptables -t filter -A INPUT -p tcp --dport $DNS_PORT -j ACCEPT
        iptables -t filter -A INPUT -p udp --dport $DNS_PORT -j ACCEPT

        # Autoriser HTTP et HTTPS
        iptables -t filter -A OUTPUT -p tcp --dport $HTTP_PORT -j ACCEPT
        iptables -t filter -A INPUT -p tcp --dport $HTTP_PORT -j ACCEPT
        iptables -t filter -A OUTPUT -p tcp --dport $HTTPS_PORT -j ACCEPT
        iptables -t filter -A INPUT -p tcp --dport $HTTPS_PORT -j ACCEPT

}

fw_stop(){
        # Vidage des tables et des regles personnelles
        iptables -t filter      -F
        iptables -t nat         -F
        iptables -t mangle      -F
        iptables -t filter      -X

        # Interdire toutes connexions entrantes et sortantes
        iptables -t filter      -P INPUT DROP
        iptables -t filter      -P FORWARD DROP
        iptables -t filter      -P OUTPUT DROP
}
fw_clear(){
        # Vidage des tables et des regles personnelles
        iptables -t filter      -F
        iptables -t nat         -F
        iptables -t mangle      -F
        iptables -t filter      -X

        # Accepter toutes connexions entrantes et sortantes
        iptables -t filter      -P INPUT ACCEPT
        iptables -t filter      -P FORWARD ACCEPT
        iptables -t filter      -P OUTPUT ACCEPT
}

fw_stop_ip6(){
        # Vidage des tables et des regles personnelles
        ip6tables -t filter     -F
        ip6tables -t mangle     -F
        ip6tables -t filter     -X

                # Interdire toutes connexions entrantes et sortantes
        ip6tables -t filter     -P INPUT DROP
        ip6tables -t filter     -P FORWARD DROP
        ip6tables -t filter     -P OUTPUT DROP
}

fw_clear_ip6(){
        # Vidage des tables et des regles personnelles
        ip6tables -t filter      -F
        ip6tables -t mangle      -F
        ip6tables -t filter      -X

        # Accepter toutes connexions entrantes et sortantes
        ip6tables -t filter      -P INPUT ACCEPT
        ip6tables -t filter      -P FORWARD ACCEPT
        ip6tables -t filter      -P OUTPUT ACCEPT
}

case "$1" in
        start|restart)
                echo -n "Starting firewall.."
                fw_stop_ip6
                fw_stop
                fw_start
                echo "done."
                ;;
        stop)
                echo -n "Stopping firewall.."
                fw_stop_ip6
                fw_stop
                echo "done."
                ;;
        clear)
                echo -n "Clearing firewall rules.."
                fw_clear_ip6
                fw_clear
                echo "done."
                ;;
        *)
                echo "Usage: $0 {start|stop|restart|clear}"
                exit 1
                ;;
esac

exit 0
</code></pre>

<p>Pour tester le script il suffit de le lancer une premiÃ¨re fois et vÃ©rifier que tout fonctionne. Si câ€™est pas le cas redÃ©marrer le serveur pour y avoir accÃ¨s de nouveau.</p>

<p>Relancer le firewall:</p>

<pre><code class="language-bash">firewall.sh start
</code></pre>

<p>AprÃ¨s lâ€™avoir validÃ©, il faut que le script se lance Ã  chaque fois que le serveur dÃ©marre :</p>

<p>Relancer le firewall automatiquement:</p>

<pre><code class="language-bash">chmod +x /etc/init.d/firewall.sh
chown root:root /etc/init.d/firewall.sh
update-rc.d firewall.sh defaults
</code></pre>
    ]]></content>
</entry>
            <entry>
    <id>https://vincent.dauce.fr/blog/2014-01-15-administrer-un-serveur-dedie-part-1-introduction</id>
    <link type="text/html" rel="alternate" href="https://vincent.dauce.fr/blog/2014-01-15-administrer-un-serveur-dedie-part-1-introduction" />
    <title>Administrer un serveur dÃ©diÃ© - part 1 : Introduction</title>
    <published>2014-01-15T00:00:00+00:00</published>
    <updated>2014-01-15T00:00:00+00:00</updated>
    <author>
        <name>Vincent Dauce</name>
    </author>
    <summary type="html">Lâ€™idÃ©e de dÃ©part pour ce blog Ã©tait de partager mon expÃ©rience pour administrer un serveur dÃ©diÃ©, donc commenÃ§ons par lÃ .

Jâ€™ai depuis de nombreuses annÃ©es maintenant une dÃ©dibox pour hÃ©berger mes sites internet que je change......</summary>
    <content type="html"><![CDATA[
        <p>Lâ€™idÃ©e de dÃ©part pour ce blog Ã©tait de partager mon expÃ©rience pour administrer un serveur dÃ©diÃ©, donc commenÃ§ons par lÃ .</p>

<p>Jâ€™ai depuis de nombreuses annÃ©es maintenant une <a href="http://www.online.net/fr">dÃ©dibox</a> pour hÃ©berger mes sites internet que je change rÃ©guliÃ¨rement pour profiter des nouvelles offres, des nouveaux prix, dâ€™un nouveau datacenter, â€¦</p>

<p>Ã‡a faisait 2 ans (2011-2013) que jâ€™avais une <a href="http://documentation.online.net/fr/serveur-dedie/offres/serveur-dedibox-pro-dell/start">DEDIBOX PRO DELL</a> et jâ€™ai dÃ©cidÃ© il y a quelques mois de me relancer dans une migration pour profiter de plusieurs points :</p>

<ul>
<li>Le nouveau datacenter dâ€™Online : DC2 vers <a href="http://www.iliad-datacenter.fr/datacenters/dc3">DC3</a> (avec un rÃ©seau plus performant)</li>
<li>Du matÃ©riel neuf</li>
<li>Performance Ã©quivalente car derriÃ¨re lâ€™offre câ€™est un serveur Dell R210</li>
<li>Et rÃ©installer mon systÃ¨me pour passer dâ€™une Debian 6 vers un Debian 7</li>
</ul>

<p>Jâ€™ai donc pris la <a href="http://www.online.net/fr/serveur-dedie/dedibox-lt2k14">DEDIBOX LT 2014</a> ce qui me fait passer de 50 Ã  36 euros/mois soit une Ã©conomie non nÃ©gligeable de 168 euros par an ğŸ™‚</p>

<p>Je perd uniquement 1To dans lâ€™histoire mais comme en 2 ans jâ€™avais pas rÃ©ussir Ã  remplir le disque câ€™est pas trÃ¨s grave.</p>

<p>Lâ€™objectif de cette sÃ©rie dâ€™articles sera de vous expliquer comment administrer un serveur dÃ©diÃ© et mes choix :</p>

<ul>
<li>Un socle sous <a href="http://www.debian.org/index.fr.html">Debian 7</a> avec des machines virtuelles <a href="https://wiki.debian.org/LXC">LXC</a></li>
<li>Des histoires de rÃ©seaux pour avoir des IP publique avec les IP Failover dâ€™Online</li>
<li>Pas de FTP mais du SFTP car câ€™est quand mÃªme mieux Ã  notre Ã©poque</li>
<li>Un serveur Web avec Apache, son copain PHP et son ami MySQL</li>
<li>Installer un cloud avec <a href="http://owncloud.org/">Owncloud</a> pour stocker des fichiers en HTTPS</li>
<li>â€¦.</li>
</ul>

<p>A bientÃ´t donc pour le dÃ©but du dÃ©ploiement â€¦</p>
    ]]></content>
</entry>
    </feed>
