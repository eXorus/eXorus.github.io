<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <meta name="description" content="">

        <meta property="og:title" content="Administrer un serveur dÃ©diÃ© - part 7 : Backup MySQL | Blog de Vincent Dauce"/>
        <meta property="og:type" content="article" />
        <meta property="og:url" content="https://vincent.dauce.fr/blog/2014-04-03-administrer-un-serveur-dedie-part-7-backup-mysql"/>
        <meta property="og:description" content="" />

        <title>Administrer un serveur dÃ©diÃ© - part 7 : Backup MySQL | Blog de Vincent Dauce</title>

        <link rel="home" href="https://vincent.dauce.fr">
        <link rel="icon" href="/favicon.ico">
        <link href="/blog/feed.atom" type="application/atom+xml" rel="alternate" title="Blog de Vincent Dauce Atom Feed">

                    <!-- Fathom - beautiful, simple website analytics -->
            <script src="https://cdn.usefathom.com/script.js" data-site="VSUJDIGQ" defer></script>
            <!-- / Fathom -->
        
        <link href="https://fonts.googleapis.com/css?family=Nunito+Sans:300,300i,400,400i,700,700i,800,800i" rel="stylesheet">
        <link rel="stylesheet" href="/assets/build/css/main.css?id=3717bee9ccac7506b103bbe24c27e2de">
    </head>

    <body class="flex flex-col justify-between min-h-screen bg-gray-100 text-gray-800 leading-normal font-sans">
        <header class="flex items-center shadow bg-white border-b h-24 py-4" role="banner">
            <div class="container flex items-center max-w-8xl mx-auto px-4 lg:px-8">
                <div class="flex items-center">
                    <a href="/" title="Blog de Vincent Dauce home" class="inline-flex items-center">
                        <img class="h-8 md:h-10 mr-3" src="/assets/img/logo.svg" alt="Blog de Vincent Dauce logo" />

                        <h1 class="text-lg md:text-2xl text-blue-800 font-semibold hover:text-blue-600 my-0">Blog de Vincent Dauce</h1>
                    </a>
                </div>

                <div id="vue-search" class="flex flex-1 justify-end items-center">
                    <search></search>

                    <nav class="hidden lg:flex items-center justify-end text-lg">
    <a title="Blog de Vincent Dauce Blog" href="/blog"
        class="ml-6 text-gray-700 hover:text-blue-600 ">
        Blog
    </a>

    <a title="Blog de Vincent Dauce About" href="/about"
        class="ml-6 text-gray-700 hover:text-blue-600 ">
        About
    </a>

    <a title="Blog de Vincent Dauce Contact" href="/contact"
        class="ml-6 text-gray-700 hover:text-blue-600 ">
        Contact
    </a>
</nav>

                    <button class="flex justify-center items-center bg-blue-500 border border-blue-500 h-10 px-5 rounded-full lg:hidden focus:outline-none"
    onclick="navMenu.toggle()"
>
    <svg id="js-nav-menu-show" xmlns="http://www.w3.org/2000/svg"
        class="fill-current text-white h-9 w-4" viewBox="0 0 32 32"
    >
        <path d="M4,10h24c1.104,0,2-0.896,2-2s-0.896-2-2-2H4C2.896,6,2,6.896,2,8S2.896,10,4,10z M28,14H4c-1.104,0-2,0.896-2,2  s0.896,2,2,2h24c1.104,0,2-0.896,2-2S29.104,14,28,14z M28,22H4c-1.104,0-2,0.896-2,2s0.896,2,2,2h24c1.104,0,2-0.896,2-2  S29.104,22,28,22z"/>
    </svg>

    <svg id="js-nav-menu-hide" xmlns="http://www.w3.org/2000/svg"
        class="hidden fill-current text-white h-9 w-4" viewBox="0 0 36 30"
    >
        <polygon points="32.8,4.4 28.6,0.2 18,10.8 7.4,0.2 3.2,4.4 13.8,15 3.2,25.6 7.4,29.8 18,19.2 28.6,29.8 32.8,25.6 22.2,15 "/>
    </svg>
</button>

                </div>
            </div>
        </header>

        <nav id="js-nav-menu" class="w-auto px-2 pt-6 pb-2 bg-gray-200 shadow hidden lg:hidden">
    <ul class="my-0">
        <li class="pl-4">
            <a
                title="Blog de Vincent Dauce Blog"
                href="/blog"
                class="block mt-0 mb-4 text-sm no-underline text-gray-800 hover:text-blue-500"
            >Blog</a>
        </li>
        <li class="pl-4">
            <a
                title="Blog de Vincent Dauce About"
                href="/about"
                class="block mt-0 mb-4 text-sm no-underline text-gray-800 hover:text-blue-500"
            >About</a>
        </li>
        <li class="pl-4">
            <a
                title="Blog de Vincent Dauce Contact"
                href="/contact"
                class="block mt-0 mb-4 text-sm no-underline text-gray-800 hover:text-blue-500"
            >Contact</a>
        </li>
    </ul>
</nav>

        <main role="main" class="flex-auto w-full container max-w-4xl mx-auto py-16 px-6">
                
    <h1 class="leading-none mb-2">Administrer un serveur dÃ©diÃ© - part 7 : Backup MySQL</h1>

    <p class="text-gray-700 text-xl md:mt-0">Vincent Dauce  â€¢  April 3, 2014</p>

                        <a
                href="/blog/categories/admin"
                title="View posts in admin"
                class="inline-block bg-gray-300 hover:bg-blue-200 leading-loose tracking-wide text-gray-800 uppercase text-xs font-semibold rounded mr-4 px-3 pt-px"
            >admin</a>
            
    <div class="border-b border-blue-200 mb-10 pb-4" v-pre>
        <p>Sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, sauvegarder, â€¦</p>

<p>Et oui on ne le rÃ©pÃ©tera jamais assez il faut penser Ã  sauvegarder vos donnÃ©es avant tout. Le 31 mars est la journÃ©e international de la sauvegarde donc parlons en. aujourdâ€™hui.</p>

<p>La solution proposÃ©e ici est simple car nous allons sauvegarder uniquement les bases de donnÃ©es mais dans un prochain article nous pourrions voir comment sauvegarder directement un container. Lâ€™avantage serait de sauvegarder la base de donnÃ©es et les fichiers et de faciliter la restauration en cas de sinistre.</p>

<p>â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”</p>

<p>27/04/2014 : Ajout de lâ€™expiration du mot de passe au bout de 100 jours pour plus de sÃ©curitÃ© (cmd chage)</p>

<p>28/05/2014 : Modification de lâ€™offre de sauvegarde gratuite dâ€™Online, on passe de 10Go Ã  100Go cool !!!</p>

<p>â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”<br />
Nous allons mettre en place dans <strong>chaque</strong> <strong>container</strong> (ayant une base de donnÃ©es MySQL) un script qui va lister les base de donnÃ©es, les sauvegarder en local et les envoyer sur le FTP offert par Online.</p>

<h2>CrÃ©ation du compte systÃ¨me</h2>

<p>CrÃ©ation et initilisation du mdp:</p>

<pre><code class="language-bash">useradd -g www-data -m MySQLBackupManager
passwd MySQLBackupManager
chage -M 100 
</code></pre>

<p>Le compte sera MySQLBackupManager avec un mot de passe compliquÃ©e comme dâ€™habitude ğŸ™‚</p>

<p>On va nettoyer le rÃ©pertoire personnelle du compte pour ne laisser que le script nÃ©cessaire et les sauvegardes locales</p>

<p>Nettoyer le rÃ©pertoire personnel:</p>

<pre><code class="language-bash">su - MySQLBackupManager
rm -rf /home/MySQLBackupManager
mkdir scripts
mkdir tmp
mkdir logs
mkdir backups_daily
mkdir backups_weekly
</code></pre>

<p>VoilÃ  tout est en place il reste le fameux scripts mais nous allons dâ€™abord rÃ©cupÃ©rer les informations nÃ©cessaires avant.</p>

<p>Tout le reste se passe avec le compte MySQLBackupManager</p>

<h2>CrÃ©ation du compte MySQL</h2>

<p>Se connecter en root Ã  MySQL:</p>

<pre><code class="language-bash">mysql -h localhost -u root -p
</code></pre>

<p>CrÃ©ation du compte:</p>

<pre><code class="language-sql">CREATE USER 'mysql-backup-manager'@'localhost' IDENTIFIED BY 'MON_PASSWORD';
FLUSH PRIVILEGES;
EXIT;
</code></pre>

<p>Remplacer par le mot de passe que vous souhaitez.</p>

<h2>RÃ©cupÃ©rer les informations du serveur distant</h2>

<p>Dans la console Online, sur la liste des serveurs sÃ©lectionner votre serveur.</p>

<p>Dans lâ€™onglet Â« Sauvegarde Â», activer le compte FTP. Online offre gratuitement un espace de stockage de <del>10Go</del> 100Go (depuis le 28/05/2014) nâ€™est ce pas magnifique ? En plus câ€™est fait intelligement câ€™est Ã  dire que votre serveur de backup est toujours dans un autre datacenter que votre serveur donc en cas dâ€™accident (incendie) et bien vos donnÃ©es seront sauvÃ©es.</p>

<p>AprÃ¨s lâ€™activation rÃ©cupÃ©rer :</p>

<ul>
<li>lâ€™adresse FTP : dedibackup-dc2.online.net</li>
<li>le login : le nom de votre serveur sd-xxxxx</li>
<li>le mot de passe</li>
</ul>

<h2>Mise en place du script de sauvegarde</h2>

<p>RÃ©cupÃ©rer le script sur mon github :</p>

<p><a href="https://github.com/eXorus/eXorus/blob/master/MySQLBackupManager/MySQLBackupManager.sh" title="Afficher MySQLBackupManager.sh">MySQLBackupManager.sh</a> <a href="https://raw.github.com/eXorus/eXorus/master/MySQLBackupManager/MySQLBackupManager.sh" title="Back to MySQLBackupManager.sh">affichage brut</a>:</p>

<pre><code class="language-bash">!/bin/bash

#---------------------------------------------------------------#
# ParamÃ©trage de la connection MySQL                            #
#---------------------------------------------------------------#

#Nom de l'utilisateur qui lance le backup
user=mysql-backup-manager
#Machine sur laquelle on se connecte
host=localhost
#Mot de passe de l'utilisateur de backup
pass=mon_mot_de_passe_system

# Outil de dump
MYSQLDUMP=mysqldump
#Outil de check
MYSQLCHECK=mysqlcheck
# Options passÃ©es |  MYSQLDUMP
OPTIONS="--add-drop-database  --add-drop-table --complete-insert --routines --triggers --max_allowed_packet=250M --force"

#---------------------------------------------------------------#
# ParamÃ©trage de la sauvegarde                                  #
#---------------------------------------------------------------#

# RÃ©pertoire temporaire pour stocker les backups
TEMPORAIRE="/home/MySQLBackupManager/tmp"

# Nom du serveur
MACHINE="$(hostname)"

# Date jour
DATE_DAILY="$(date +"%Y-%m-%d")"
#Retention des sauvegardes journaliÃ¨res
DAILY_RETENTION=15

# Date semaine
DATE_WEEKLY="$(date +"%U")"
#Retention des sauvegardes hebdomadaires
WEEKLY_RETENTION=200

# Nom des fichiers de backup
# RÃ©pertoire de destination du backup
REP_DAILY="backups_daily"
REP_WEEKLY="backups_weekly"
DESTINATION_DAILY="/home/MySQLBackupManager/"$REP_DAILY
DESTINATION_WEEKLY="/home/MySQLBackupManager/"$REP_WEEKLY
FICHIER_BACKUP_DAILY=$MACHINE"_BACKUP_MYSQL_"$DATE_DAILY".tar.gz"
FICHIER_BACKUP_WEEKLY=$MACHINE"_BACKUP_MYSQL_S"$DATE_WEEKLY".tar.gz"

#Informations FTP
LOGIN_FTP=sd-xxxx
PASS_FTP=mon_mot_de_passe_ftp
HOST_FTP=dedibackup-dc2.online.net
FTP_DAILY=$MACHINE"/"$REP_DAILY
FTP_WEEKLY=$MACHINE"/"$REP_WEEKLY

#---------------------------------------------------------------#
# Process de sauvegarde                                         #
#---------------------------------------------------------------#
# CrÃ©ation du rÃ©pertoire temporaire
if [ -d $TEMPORAIRE ];
then
  echo "Le repertoire "$TEMPORAIRE" existe.";
else
  mkdir $TEMPORAIRE;
  echo "CrÃ©ation du repertoire "$TEMPORAIRE".";
fi

# On construit la liste des bases de donnÃ©es
BASES="$(mysql -u $user -h $host -p$pass -Bse 'show databases')"

# On lance le dump des bases
for db in $BASES
do
  if [ $db != "information_schema" ]; then
    #On lance un check et une analyse pour chaque base de donnÃ©es
    $MYSQLCHECK -u $user -h $host -p$pass -c -a $db
    # On lance un mysqldump pour chaque base de donnÃ©es
    $MYSQLDUMP -u $user -h $host -p$pass $OPTIONS $db -R &gt; $TEMPORAIRE"/"$MACHINE"-"$db"-"$DATE_DAILY".sql";
  fi
done

# CrÃ©ation du rÃ©pertoire de destination journalier
if [ -d $DESTINATION_DAILY ];
then
  echo "Le repertoire "$DESTINATION_DAILY" existe.";
else
  mkdir $DESTINATION_DAILY;
  echo "CrÃ©ation du repertoire "$DESTINATION_DAILY".";
fi

# CrÃ©ation de l'archive contenant tout les dump
#Cette archive est stockÃ©e dans le dossier dÃ©fini pour la sauvegarde
cd $TEMPORAIRE
tar -cvzf $DESTINATION_DAILY"/"$FICHIER_BACKUP_DAILY *

# CrÃ©ation du rÃ©pertoire de destination semaine
if [ -d $DESTINATION_WEEKLY ];
then
  echo "Le repertoire "$DESTINATION_WEEKLY" existe.";
else
  mkdir $DESTINATION_WEEKLY;
  echo "CrÃ©ation du repertoire "$DESTINATION_WEEKLY".";
fi

#Copie de la sauvagarde semaine
if [ -f $DESTINATION_WEEKLY"/"$FICHIER_BACKUP_WEEKLY  ];
then
    echo "La sauvegarde "$DESTINATION_WEEKLY"/"$FICHIER_BACKUP_WEEKLY" existe.";
else
    echo "CrÃ©ation de la sauvegarde "$DESTINATION_WEEKLY"/"$FICHIER_BACKUP_WEEKLY".";
    cp $DESTINATION_DAILY"/"$FICHIER_BACKUP_DAILY $DESTINATION_WEEKLY"/"$FICHIER_BACKUP_WEEKLY
fi

# On supprime le fichier
find $DESTINATION_DAILY -type f -mtime +$DAILY_RETENTION | xargs -r rm
find $DESTINATION_WEEKLY -type f -mtime +$WEEKLY_RETENTION | xargs -r rm

# On transfere l'archive par FTP
lftp $HOST_FTP&lt;&lt;SCRIPTFTP
user $LOGIN_FTP $PASS_FTP
mirror -R $DESTINATION_DAILY"/" $FTP_DAILY"/"
mirror -R $DESTINATION_WEEKLY"/" $FTP_WEEKLY"/"
du -hs /
bye
SCRIPTFTP

# On suprime le rÃ©pertoire temporaire
if [ -d $TEMPORAIRE ]; then
  rm -Rf $TEMPORAIRE
fi
</code></pre>

<p>RÃ©cupÃ©rer, DÃ©poser et donner les droits:</p>

<pre><code class="language-bash">cd /home/MySQLBackupManager/scripts
wget https://raw.githubusercontent.com/eXorus/eXorus/master/MySQLBackupManager/MySQLBackupManager.sh
chmod 700 MySQLBackupManager.sh
vi MySQLBackupManager.sh
</code></pre>

<p>On rÃ©cupÃ¨re le script on ajout les droits uniquement pour le compte MySQLBackupManager et ensuite on lâ€™Ã©dite pour modifier quelques informations :</p>

<ul>
<li>user /host / pass : pour se connecter Ã  la machine ici nous sommes en local câ€™est donc plus simple mais ca fonctionne aussi avec un serveur distant</li>
<li>LOGIN_FTP / PASS_FTP / HOST_FTP : pour se connecter au serveur distant (FTP) qui va rÃ©cupÃ©rer les sauvegardes</li>
</ul>

<p>Câ€™est tout.</p>

<p>Pour que le script fonctionne nous devons installer 2 outils :</p>

<ul>
<li>aptitude install cron : pour automatiser la sauvegarde</li>
<li>aptitude install lftp : pour faire du ftp sur le serveur distant</li>
</ul>

<p>Ensuite nous devons configurer le cron (tÃ¢che planifiÃ©e qui va sâ€™exÃ©cuter tous les jours Ã  4h du matin)</p>

<p>Crontab:</p>

<pre><code class="language-bash">crontab -e
        0 4 * * * /home/MySQLBackupManager/scripts/MySQLBackupManager.sh &gt;&gt;/home/MySQLBackupManager/logs/MySQLBackupManager.log
</code></pre>

<p>Vous pouvez tester le script manuellement la premiÃ¨re fois pour vÃ©rifier que tout fonctionne correctement :</p>

<p>Tester le script manuellement:</p>

<pre><code class="language-bash">./MySQLBackupManager
</code></pre>

<p>Et vÃ©rifier avec les logs que tout se passe bien.</p>

<h2>Quoi sauvegarder ?</h2>

<p>VoilÃ  nos sauvegardes MySQL sont en place reste juste Ã  indiquer les bases Ã  sauvegarder. Pour cela il suffit de donner au compte mysql-backup-manager les droits suffisants.</p>

<p>Se connecter en root Ã  MySQL:</p>

<pre><code class="language-bash">mysql -h localhost -u root -p
</code></pre>

<p>Activer la sauvegarde de la BDD mydatabase:</p>

<pre><code class="language-sql">GRANT SELECT , INSERT , LOCK TABLES ON `mydatabase` . * TO 'mysql-backup-manager'@'localhost';
FLUSH PRIVILEGES;
EXIT:
</code></pre>

<p>A reproduire sur toutes les bases Ã  sauvegarder. Jâ€™ai mis Ã  jour le post concernant la <a href="http://vincent.dauce.fr/administrer-un-serveur-dedie-part-6-espace-web/" title="Administrer un serveur dÃ©diÃ© â€“ part 6 : Espace Web">crÃ©ation dâ€™un espace web</a> pour lâ€™activer par dÃ©faut.</p>

<h2>Sauvegarde sur le FTP</h2>

<p>Sur le FTP Online vous retrouverez la structure suivante :</p>

<ul>
<li>[CT101]

<ul>
<li>backups_daily

<ul>
<li>CT101_BACKUP_MYSQL_2014-01-28.tar.gz</li>
<li>CT101_BACKUP_MYSQL_2014-01-29.tar.gz</li>
<li>â€¦</li>
</ul></li>
<li>backups_weekly

<ul>
<li>CT101_BACKUP_MYSQL_S04.tar.gz</li>
<li>CT101_BACKUP_MYSQL_S05.tar.gz</li>
<li>â€¦</li>
</ul></li>
</ul></li>
<li>[CT102]

<ul>
<li>backups_daily

<ul>
<li>â€¦</li>
</ul></li>
<li>backups_weekly

<ul>
<li>â€¦</li>
</ul></li>
</ul></li>
</ul>

<p>Câ€™est largement suffisant pour avoir toujours la bonne sauvegarde au bon moment. Attention vous Ãªtes limitÃ©s Ã  100 fichiers sur le serveur FTP dâ€™Online.</p>

<p>DerniÃ¨re chose il faut penser Ã  vÃ©rifier le lendemain que votre sauvegarde a bien fonctionner et essayer de la restaurer dans une base de donnÃ©es vide et voir que les donnÃ©es ne sont pas corrompues sinon tout le travail ci-dessous nâ€™aura servi Ã  rien.</p>

<p>Â« Save today, Tomorrow is too late Â»</p>
    </div>

    <nav class="flex justify-between text-sm md:text-base">
        <div>
                            <a href="https://vincent.dauce.fr/blog/2014-03-08-php-securite-faille-xss" title="Older Post: Php SÃ©curitÃ© â€“ DÃ©couverte de la faille XSS et comment s&#039;en protÃ©ger">
                    &LeftArrow; Php SÃ©curitÃ© â€“ DÃ©couverte de la faille XSS et comment s&#039;en protÃ©ger
                </a>
                    </div>

        <div>
                    </div>
    </nav>
        </main>

        <footer class="bg-white text-center text-sm mt-12 py-4" role="contentinfo">
            <ul class="flex flex-col md:flex-row justify-center list-none">
                <li class="md:mr-2">
                    &copy; <a href="https://tighten.co" title="Tighten website">Tighten</a> 2025.
                </li>

                <li>
                    Built with <a href="http://jigsaw.tighten.co" title="Jigsaw by Tighten">Jigsaw</a>
                    and <a href="https://tailwindcss.com" title="Tailwind CSS, a utility-first CSS framework">Tailwind CSS</a>.
                </li>
            </ul>
        </footer>

        <script src="/assets/build/js/main.js?id=ab5beb18484060678105469b256b9364"></script>

        <script>
    const navMenu = {
        toggle() {
            const menu = document.getElementById('js-nav-menu');
            menu.classList.toggle('hidden');
            menu.classList.toggle('lg:block');
            document.getElementById('js-nav-menu-hide').classList.toggle('hidden');
            document.getElementById('js-nav-menu-show').classList.toggle('hidden');
        },
    }
</script>
    </body>
</html>
