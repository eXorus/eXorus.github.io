<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <meta name="description" content="mise en place de la virtualisation avec LXC et configuration du réseau">

        <meta property="og:title" content="Administrer un serveur dédié - part 3 : Virtualisation | Blog de Vincent Dauce"/>
        <meta property="og:type" content="article" />
        <meta property="og:url" content="https://vincent.dauce.fr/blog/2014-01-25-administrer-un-serveur-dedie-part-3-virtualisation"/>
        <meta property="og:description" content="mise en place de la virtualisation avec LXC et configuration du réseau" />

        <title>Administrer un serveur dédié - part 3 : Virtualisation | Blog de Vincent Dauce</title>

        <link rel="home" href="https://vincent.dauce.fr">
        <link rel="icon" href="/favicon.ico">
        <link href="/blog/feed.atom" type="application/atom+xml" rel="alternate" title="Blog de Vincent Dauce Atom Feed">

                    <!-- Fathom - beautiful, simple website analytics -->
            <script src="https://cdn.usefathom.com/script.js" data-site="VSUJDIGQ" defer></script>
            <!-- / Fathom -->
        
        <link href="https://fonts.googleapis.com/css?family=Nunito+Sans:300,300i,400,400i,700,700i,800,800i" rel="stylesheet">
        <link rel="stylesheet" href="/assets/build/css/main.css?id=3717bee9ccac7506b103bbe24c27e2de">
    </head>

    <body class="flex flex-col justify-between min-h-screen bg-gray-100 text-gray-800 leading-normal font-sans">
        <header class="flex items-center shadow bg-white border-b h-24 py-4" role="banner">
            <div class="container flex items-center max-w-8xl mx-auto px-4 lg:px-8">
                <div class="flex items-center">
                    <a href="/" title="Blog de Vincent Dauce home" class="inline-flex items-center">
                        <img class="h-8 md:h-10 mr-3" src="/assets/img/logo.svg" alt="Blog de Vincent Dauce logo" />

                        <h1 class="text-lg md:text-2xl text-blue-800 font-semibold hover:text-blue-600 my-0">Blog de Vincent Dauce</h1>
                    </a>
                </div>

                <div id="vue-search" class="flex flex-1 justify-end items-center">
                    <search></search>

                    <nav class="hidden lg:flex items-center justify-end text-lg">
    <a title="Blog de Vincent Dauce Blog" href="/blog"
        class="ml-6 text-gray-700 hover:text-blue-600 ">
        Blog
    </a>

    <a title="Blog de Vincent Dauce About" href="/about"
        class="ml-6 text-gray-700 hover:text-blue-600 ">
        About
    </a>

    <a title="Blog de Vincent Dauce Contact" href="/contact"
        class="ml-6 text-gray-700 hover:text-blue-600 ">
        Contact
    </a>
</nav>

                    <button class="flex justify-center items-center bg-blue-500 border border-blue-500 h-10 px-5 rounded-full lg:hidden focus:outline-none"
    onclick="navMenu.toggle()"
>
    <svg id="js-nav-menu-show" xmlns="http://www.w3.org/2000/svg"
        class="fill-current text-white h-9 w-4" viewBox="0 0 32 32"
    >
        <path d="M4,10h24c1.104,0,2-0.896,2-2s-0.896-2-2-2H4C2.896,6,2,6.896,2,8S2.896,10,4,10z M28,14H4c-1.104,0-2,0.896-2,2  s0.896,2,2,2h24c1.104,0,2-0.896,2-2S29.104,14,28,14z M28,22H4c-1.104,0-2,0.896-2,2s0.896,2,2,2h24c1.104,0,2-0.896,2-2  S29.104,22,28,22z"/>
    </svg>

    <svg id="js-nav-menu-hide" xmlns="http://www.w3.org/2000/svg"
        class="hidden fill-current text-white h-9 w-4" viewBox="0 0 36 30"
    >
        <polygon points="32.8,4.4 28.6,0.2 18,10.8 7.4,0.2 3.2,4.4 13.8,15 3.2,25.6 7.4,29.8 18,19.2 28.6,29.8 32.8,25.6 22.2,15 "/>
    </svg>
</button>

                </div>
            </div>
        </header>

        <nav id="js-nav-menu" class="w-auto px-2 pt-6 pb-2 bg-gray-200 shadow hidden lg:hidden">
    <ul class="my-0">
        <li class="pl-4">
            <a
                title="Blog de Vincent Dauce Blog"
                href="/blog"
                class="block mt-0 mb-4 text-sm no-underline text-gray-800 hover:text-blue-500"
            >Blog</a>
        </li>
        <li class="pl-4">
            <a
                title="Blog de Vincent Dauce About"
                href="/about"
                class="block mt-0 mb-4 text-sm no-underline text-gray-800 hover:text-blue-500"
            >About</a>
        </li>
        <li class="pl-4">
            <a
                title="Blog de Vincent Dauce Contact"
                href="/contact"
                class="block mt-0 mb-4 text-sm no-underline text-gray-800 hover:text-blue-500"
            >Contact</a>
        </li>
    </ul>
</nav>

        <main role="main" class="flex-auto w-full container max-w-4xl mx-auto py-16 px-6">
                
    <h1 class="leading-none mb-2">Administrer un serveur dédié - part 3 : Virtualisation</h1>

    <p class="text-gray-700 text-xl md:mt-0">Vincent Dauce  •  January 25, 2014</p>

                        <a
                href="/blog/categories/admin"
                title="View posts in admin"
                class="inline-block bg-gray-300 hover:bg-blue-200 leading-loose tracking-wide text-gray-800 uppercase text-xs font-semibold rounded mr-4 px-3 pt-px"
            >admin</a>
            
    <div class="border-b border-blue-200 mb-10 pb-4" v-pre>
        <p>On va passer à la virtualisation, c’est à la mode et c’est super efficace. L’objectif est d’avoir avec un serveur plusieurs serveurs.</p>

<p>Avant j’utilisais la solution OpenVZ mais depuis Debian Wheezy la solution préconisée est LXC même si elle ne semble pas encore très mature elle fonctionne parfaitement.</p>

<p>Les avantages de LXC par rapport à OpenVZ c’est :</p>

<ul>
<li>Le noyau qui est « mainline » donc pas besoin de le patcher comme pour OpenVZ, c’est juste un package Debian comme les autres</li>
<li>C’est forcément le future, bien que pas totalement mature pour le moment il va devenir une référence plus tard</li>
<li>OpenVZ même si il est gratuit est maintenu par une société Parallels qui vent des solutions de virtualisation</li>
</ul>

<p>Voici donc l’architecture qu’on va mettre en place :</p>

<ul>
<li>On va installer LXC sur notre serveur (host)</li>
<li>On va créer plusieurs containers (ie serveurs) pour différents usages:

<ul>
<li>CT101 : Container pour héberger les sites internet en production</li>
<li>CT102 : Container pour héberger mes sites personnels (ma vie privée)</li>
<li>CT103 : Container pour héberger mes sites en développements</li>
</ul></li>
</ul>

<p>On va devoir configurer un réseau pour que notre host redirige les flux entrants et sortants vers le bon container. Pour cela on va s’appuyer sur des IP Failover que propose Online. Ces IP que tu loues à l’unité vont te permettre de faire croire au monde entier que tu as plusieurs serveurs.</p>

<p>Le host aura 2 IP, une IP publique HN&#95;IP et une privée 192.168.0.1 pour dialoguer avec les autres containers</p>

<p>Le CT101 aura aussi 2 IP, une IP publique (failover) CT101&#95;IP&#95;PUBLIC et une privée 192.168.0.101.</p>

<p>Même chose pour CT102, CT103, ….</p>

<h2>Installation de LXC</h2>

<p>C’est très facile il suffit de lancer la commande et on demandera uniquement de valider le répertoire. On va laisser celui par défaut c’est à dire /var/lib/lxc</p>

<p>Installer LXC:</p>

<pre><code class="language-bash">aptitude install lxc bridge-utils libvirt-bin debootstrap
</code></pre>

<p>LXC a besoin de <a href="http://fr.wikipedia.org/wiki/Cgroups">cgroups</a> pour limiter les ressources du serveur sur chaque container donc on va l’activer :</p>

<p>Activer cgroups:</p>

<pre><code class="language-bash">echo "cgroup /sys/fs/cgroup cgroup defaults 0 0" &gt;&gt; /etc/fstab
mount /sys/fs/cgroup
</code></pre>

<p>La première ligne permet de l’activer par défaut au démarrage du serveur et la seconde permet de l’activer maintenant.</p>

<p>Enfin il faut vérifier que l’installation de LXC est bonne et vérifier le résultat de la commande checkconfig</p>

<p>Vérifier l'installation de LXC:</p>

<pre><code class="language-bash">lxc-checkconfig
</code></pre>

<h2>Modification du réseau</h2>

<p>Surement la partie la plus dure car il y a plusieurs méthodes possible.</p>

<p>Après l’installation d’une Debian vous devriez avoir le réseau configuré de cette manière :</p>

<p>Réseau par défaut:</p>

<pre><code class="language-bash"># The loopback network interface
auto lo
iface lo inet loopback

# The primary network interface
allow-hotplug eth0
iface eth0 inet dhcp
</code></pre>

<p>A modifier par :</p>

<p>vi /etc/network/interfaces:</p>

<pre><code class="language-bash"># The loopback network interface
auto lo
iface lo inet loopback

# The primary network interface
auto eth0
iface eth0 inet static
       address xx.xx.xx.xx
       netmask 255.255.255.0
       network xx.xx.xx.0
       broadcast xx.xx.xx.255
       gateway xx.xx.xx.1
       post-up echo 1 &gt; /proc/sys/net/ipv4/ip_forward

# The bridge network interface
auto br0
iface br0 inet static
       address 192.168.0.1
       netmask 255.255.255.0
       bridge_ports none
       bridge_stp off
       bridge_fd 0
       bridge_maxwait 5 
</code></pre>

<p>Une petite explication s’impose avant on avait un réseau avec 2 interfaces :</p>

<ul>
<li>La boucle local pour que le serveur se parle à lui même (localhost)</li>
<li>L’interface principal avec notre IP publique que nous récupérons directement des serveurs DHCP d’Online.</li>
</ul>

<p>Nos modifications sont les suivantes :</p>

<ul>
<li>On ne touche pas à la boucle local</li>
<li>L’interface principale passe en mode manuel (dhcp vers static), c’est à dire qu’on va spécifier les informations au lieu de laisser les serveurs DHCP faire le boulot

<ul>
<li>address : IP publique de votre serveur (disponible sur le panel Online)</li>
<li>network : La même que ci-dessus avec un 0 à la fin</li>
<li>broadcast : La même que ci-dessus avec un 255 à la fin cette fois</li>
<li>gateway : La même que ci-dessus avec un 1 à la fin cette fois</li>
<li>ip_forward : permet d’activer l’IP Forwarding ca va nous servir pour nos containers</li>
</ul></li>
<li>On rajoute une interface bridge, en gros un switch sur lequel on va connecter les autres containers.

<ul>
<li>address : c’est l’IP privée de notre host</li>
</ul></li>
</ul>

<p><a href="http://vincent.dauce.fr/wp-content/uploads/2014/02/lxc-veth.png"><img src="http://vincent.dauce.fr/wp-content/uploads/2014/02/lxc-veth-300x167.png" alt="lxc-veth" /></a></p>

<p>Pour le moment nous avons mis en place que l’interface eth0 et br0 sur le host. Nous verrons dans un prochain article l’interface vethCT101 connecté avec l’interface eth0 du container en question.</p>

<p>Un très bon tuto de Albin Kauffman (d’où j’ai repris l’image en l’adaptant à ma terminologie) :</p>

<p><a href="http://www.linuxembedded.fr/2013/07/configuration-reseau-de-lxc/">http://www.linuxembedded.fr/2013/07/configuration-reseau-de-lxc/</a></p>

<p>Merci à lui.</p>

<h2>Quelques commandes avec LXC</h2>

<p>Lister les containers:</p>

<pre><code class="language-bash">lxc-list
</code></pre>

<p>Démarrer le container CT101:</p>

<pre><code class="language-bash">lxc-start -n CT101 -d
</code></pre>

<p>Se connecter sur le container CT101:</p>

<pre><code class="language-bash">lxc-console -n CT101
</code></pre>

<p>Il y a visiblement plusieurs méthodes (« lxc-halt -n CT101 » ou « lxc-stop -n CT101 ») pour arrêter un container mais elles ne sont pas dès plus douces. La solution la plus propre consiste à se connecter dessus à l’arrêter puis à dire à LXC de la stopper.</p>

<p>Arrêter le container CT101:</p>

<pre><code class="language-bash">#HOST&gt; lxc-console -n CT101
#CT101&gt; init 0
#HOST&gt; lxc-stop -n CT101
</code></pre>

<p>Supprimer le container CT101:</p>

<pre><code class="language-bash">lxc-destroy -n CT101
</code></pre>
    </div>

    <nav class="flex justify-between text-sm md:text-base">
        <div>
                            <a href="https://vincent.dauce.fr/blog/2014-01-20-administrer-un-serveur-dedie-part-2-le-socle" title="Older Post: Administrer un serveur dédié - part 2 : Le socle">
                    &LeftArrow; Administrer un serveur dédié - part 2 : Le socle
                </a>
                    </div>

        <div>
                            <a href="https://vincent.dauce.fr/blog/2014-02-01-administrer-un-serveur-dedie-part-4-premier-container" title="Newer Post: Administrer un serveur dédié - part 4 : Premier container">
                    Administrer un serveur dédié - part 4 : Premier container &RightArrow;
                </a>
                    </div>
    </nav>
        </main>

        <footer class="bg-white text-center text-sm mt-12 py-4" role="contentinfo">
            <ul class="flex flex-col md:flex-row justify-center list-none">
                <li class="md:mr-2">
                    &copy; <a href="https://tighten.co" title="Tighten website">Tighten</a> 2025.
                </li>

                <li>
                    Built with <a href="http://jigsaw.tighten.co" title="Jigsaw by Tighten">Jigsaw</a>
                    and <a href="https://tailwindcss.com" title="Tailwind CSS, a utility-first CSS framework">Tailwind CSS</a>.
                </li>
            </ul>
        </footer>

        <script src="/assets/build/js/main.js?id=ab5beb18484060678105469b256b9364"></script>

        <script>
    const navMenu = {
        toggle() {
            const menu = document.getElementById('js-nav-menu');
            menu.classList.toggle('hidden');
            menu.classList.toggle('lg:block');
            document.getElementById('js-nav-menu-hide').classList.toggle('hidden');
            document.getElementById('js-nav-menu-show').classList.toggle('hidden');
        },
    }
</script>
    </body>
</html>
