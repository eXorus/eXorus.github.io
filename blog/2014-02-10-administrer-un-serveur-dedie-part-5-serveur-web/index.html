<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <meta name="description" content="gestion d&#039;un hÃ©bergement web avec apache, mysql, php.">

        <meta property="og:title" content="Administrer un serveur dÃ©diÃ© - part 5 : Serveur Web | Blog de Vincent Dauce"/>
        <meta property="og:type" content="article" />
        <meta property="og:url" content="https://vincent.dauce.fr/blog/2014-02-10-administrer-un-serveur-dedie-part-5-serveur-web"/>
        <meta property="og:description" content="gestion d&#039;un hÃ©bergement web avec apache, mysql, php." />

        <title>Administrer un serveur dÃ©diÃ© - part 5 : Serveur Web | Blog de Vincent Dauce</title>

        <link rel="home" href="https://vincent.dauce.fr">
        <link rel="icon" href="/favicon.ico">
        <link href="/blog/feed.atom" type="application/atom+xml" rel="alternate" title="Blog de Vincent Dauce Atom Feed">

                    <!-- Fathom - beautiful, simple website analytics -->
            <script src="https://cdn.usefathom.com/script.js" data-site="VSUJDIGQ" defer></script>
            <!-- / Fathom -->
        
        <link href="https://fonts.googleapis.com/css?family=Nunito+Sans:300,300i,400,400i,700,700i,800,800i" rel="stylesheet">
        <link rel="stylesheet" href="/assets/build/css/main.css?id=3717bee9ccac7506b103bbe24c27e2de">
    </head>

    <body class="flex flex-col justify-between min-h-screen bg-gray-100 text-gray-800 leading-normal font-sans">
        <header class="flex items-center shadow bg-white border-b h-24 py-4" role="banner">
            <div class="container flex items-center max-w-8xl mx-auto px-4 lg:px-8">
                <div class="flex items-center">
                    <a href="/" title="Blog de Vincent Dauce home" class="inline-flex items-center">
                        <img class="h-8 md:h-10 mr-3" src="/assets/img/logo.svg" alt="Blog de Vincent Dauce logo" />

                        <h1 class="text-lg md:text-2xl text-blue-800 font-semibold hover:text-blue-600 my-0">Blog de Vincent Dauce</h1>
                    </a>
                </div>

                <div id="vue-search" class="flex flex-1 justify-end items-center">
                    <search></search>

                    <nav class="hidden lg:flex items-center justify-end text-lg">
    <a title="Blog de Vincent Dauce Blog" href="/blog"
        class="ml-6 text-gray-700 hover:text-blue-600 ">
        Blog
    </a>

    <a title="Blog de Vincent Dauce About" href="/about"
        class="ml-6 text-gray-700 hover:text-blue-600 ">
        About
    </a>

    <a title="Blog de Vincent Dauce Contact" href="/contact"
        class="ml-6 text-gray-700 hover:text-blue-600 ">
        Contact
    </a>
</nav>

                    <button class="flex justify-center items-center bg-blue-500 border border-blue-500 h-10 px-5 rounded-full lg:hidden focus:outline-none"
    onclick="navMenu.toggle()"
>
    <svg id="js-nav-menu-show" xmlns="http://www.w3.org/2000/svg"
        class="fill-current text-white h-9 w-4" viewBox="0 0 32 32"
    >
        <path d="M4,10h24c1.104,0,2-0.896,2-2s-0.896-2-2-2H4C2.896,6,2,6.896,2,8S2.896,10,4,10z M28,14H4c-1.104,0-2,0.896-2,2  s0.896,2,2,2h24c1.104,0,2-0.896,2-2S29.104,14,28,14z M28,22H4c-1.104,0-2,0.896-2,2s0.896,2,2,2h24c1.104,0,2-0.896,2-2  S29.104,22,28,22z"/>
    </svg>

    <svg id="js-nav-menu-hide" xmlns="http://www.w3.org/2000/svg"
        class="hidden fill-current text-white h-9 w-4" viewBox="0 0 36 30"
    >
        <polygon points="32.8,4.4 28.6,0.2 18,10.8 7.4,0.2 3.2,4.4 13.8,15 3.2,25.6 7.4,29.8 18,19.2 28.6,29.8 32.8,25.6 22.2,15 "/>
    </svg>
</button>

                </div>
            </div>
        </header>

        <nav id="js-nav-menu" class="w-auto px-2 pt-6 pb-2 bg-gray-200 shadow hidden lg:hidden">
    <ul class="my-0">
        <li class="pl-4">
            <a
                title="Blog de Vincent Dauce Blog"
                href="/blog"
                class="block mt-0 mb-4 text-sm no-underline text-gray-800 hover:text-blue-500"
            >Blog</a>
        </li>
        <li class="pl-4">
            <a
                title="Blog de Vincent Dauce About"
                href="/about"
                class="block mt-0 mb-4 text-sm no-underline text-gray-800 hover:text-blue-500"
            >About</a>
        </li>
        <li class="pl-4">
            <a
                title="Blog de Vincent Dauce Contact"
                href="/contact"
                class="block mt-0 mb-4 text-sm no-underline text-gray-800 hover:text-blue-500"
            >Contact</a>
        </li>
    </ul>
</nav>

        <main role="main" class="flex-auto w-full container max-w-4xl mx-auto py-16 px-6">
                
    <h1 class="leading-none mb-2">Administrer un serveur dÃ©diÃ© - part 5 : Serveur Web</h1>

    <p class="text-gray-700 text-xl md:mt-0">Vincent Dauce  â€¢  February 10, 2014</p>

                        <a
                href="/blog/categories/admin"
                title="View posts in admin"
                class="inline-block bg-gray-300 hover:bg-blue-200 leading-loose tracking-wide text-gray-800 uppercase text-xs font-semibold rounded mr-4 px-3 pt-px"
            >admin</a>
            
    <div class="border-b border-blue-200 mb-10 pb-4" v-pre>
        <p>Dans cet article nous allons voir comment dÃ©ployer un serveur web, pour cela nous avons besoin de plusieurs briques :</p>

<ul>
<li>Apache : câ€™est le serveur web par excellence qui reste encore majoritaire sur le web. Avec lui on va pouvoir servir des pages web statiques HTML/CSS</li>
<li>Php : Le langage que jâ€™utilises le plus pour mes sites web.</li>
<li>MySQL : La base de donnÃ©es qui est aussi prÃ©dominante (WordPress, Prestashop, â€¦)</li>
<li>SFTP : je nâ€™utilise pas de serveur FTP car je nâ€™en vois pas lâ€™intÃ©rÃªt quand on a dÃ©jÃ  SSH sur la machine autant activer SFTP.</li>
</ul>

<p>VoilÃ  bien sur on aurait pu prendre Nginx Ã  la place dâ€™Apache, MariaDB Ã  la plase de MySQL, vsFTPd Ã  la place de sftp â€¦ mais il faut faire un choix et on pourra toujours revenir dessus dans un prochain article.</p>

<p>Je vous conseil de rien nâ€™installer sur le host pour le laisser le plus propre possible et dâ€™utiliser un container. Nous souhaitons hÃ©berger nos sites sur CT101 que nous venons de crÃ©er donc câ€™est partit.</p>

<h2>Serveur Web â€“ Apache</h2>

<p>Installer Apache:</p>

<pre><code class="language-bash">aptitude install apache2
</code></pre>

<p>Il va installer plusieurs packages car <a href="https://packages.debian.org/wheezy/apache2">apache2 est un metapaquet</a>.</p>

<p>A la fin de lâ€™installation le serveur web est lancÃ© et fonctionnel. On peut le voir rapidement en saisissant dans votre navigateur lâ€™adresse IP Failover de votre container qui affichera une page web. Avant on avait connexion refusÃ©e.</p>

<p>Il y a aussi aprÃ¨s le lancement un petit warning que nous allons corriger : Â« apache2: Could not reliably determine the serverâ€™s fully qualified domain name, using 127.0.0.1 for ServerName Â»</p>

<p>Câ€™est trÃ¨s simple pour ne plus avoir les erreurs vous devez modifier le fichier suivant et ajouter cette ligne Ã  la fin du fichier :</p>

<p>vi /etc/apache2/apache2.conf:</p>

<pre><code class="language-bash">ServerName localhost
</code></pre>

<p>VÃ©rifions aussi quelques configurations dâ€™Apache pour voir si tout est en ordre :</p>

<p>VÃ©rifier que la configuration dâ€™Apache (normalement câ€™est celle par dÃ©faut) Ã©coute bien sur le port 80. Et aussi sur le port 443 un peu plus bas dans le cas ou on voudrait dÃ©ployer du SSL ce que nous ferons bientÃ´t pour notre cloud.</p>

<p>vi /etc/apache2/ports.conf:</p>

<pre><code class="language-bash">NameVirtualHost *:80
Listen 80
</code></pre>

<p>Modifier en dÃ©commentant la ligne (supprimer le #) pour passer Apache2 en UTF-8 câ€™est la norme sur le web depuis quelques annÃ©es maintenant et vous ne rencontrerez aucun problÃ¨me en encodant tous les fichiers en UTF-8.</p>

<p>vi /etc/apache2/conf.d/charset:</p>

<pre><code class="language-bash">AddDefaultCharset UTF-8
</code></pre>

<p>Pour personnaliser un peu apache je vous conseil 2 modules qui sont presque indispensable pour moi :</p>

<ul>
<li><a href="http://httpd.apache.org/docs/2.2/mod/mod_rewrite.html">rewrite</a> : permet la rÃ©Ã©criture dâ€™URL, tous les sites lâ€™utilisent de nos jours (au lieu dâ€™avoir http://vincent.dauce.fr/index.php?article=1 nous avons http://vincent.dauce.fr/mon-premier-article)</li>
<li><a href="http://httpd.apache.org/docs/current/mod/mod_userdir.html">userdir</a> : celui lÃ  est moins Ã©vident Ã§a permet de crÃ©er un hÃ©bergement web par utilisateur. Pour chaque site hÃ©bergÃ© sur ce serveur je vais crÃ©er un compte avec un mot de passe pour lui donner accÃ¨s aux fichiers et avoir un espace web. Pour sÃ©curiser le tout câ€™est moi qui lâ€™activerait ou non par compte donc par exemple compte root nâ€™a pas dâ€™espace web ğŸ™‚</li>
</ul>

<p>Pour activer les 2 modules ci-dessus nous utilisons :</p>

<p>Activer les modules principaux sur Apache:</p>

<pre><code class="language-bash">a2enmod rewrite
a2enmod userdir
</code></pre>

<p>Comme vu plus haut nous allons sÃ©curiser le module userdir avec la configuration suivante (ajouter les lignes Ã  la fin du fichier aprÃ¨s ServerName) :</p>

<p>vi /etc/apache2/apache2.conf:</p>

<pre><code class="language-bash"># Configuration du module UserDir
UserDir disabled
UserDir /home/*/www
</code></pre>

<p>Le module userdir est ainsi dÃ©sactivÃ© et sera activÃ© au cas par cas selon nos besoins. Et nous dÃ©finissons que les pages web seront dans le rÃ©pertoire /home/*/www avec * le login du compte.</p>

<p>Pour vous donner une idÃ©e, si je veux hÃ©berger le site Â« toto.com Â» je vais crÃ©er un compte toto qui aura donc un rÃ©pertoire personnel dans /home/toto. Si jâ€™active pour ce compte lâ€™espace web il pourra dÃ©poser des fichiers dans /home/toto/www et consultable via le lien CT101_IP_PUBLIC/~toto.</p>

<p>Justement pour Ã©viter dâ€™avoir Ã  crÃ©er Ã  chaque fois le dossier www nous allons automatiser la crÃ©ation et crÃ©er un dossier logs pour stocker les fichier log dâ€™Apache par compte.</p>

<p>Automatiser la crÃ©ation du dossier www:</p>

<pre><code class="language-bash">mkdir /etc/skel/www
mkdir /etc/skel/logs
echo " &lt;strong&gt;Nouvel espace web&lt;/strong&gt; " &gt; /etc/skel/www/index.html
</code></pre>

<p>Puis recharger la configuration et admirer que vous nâ€™avez plus le message dâ€™erreur :</p>

<p>Recharger apache2:</p>

<pre><code class="language-bash">service apache2 reload
</code></pre>

<h2>Serveur SQL â€“ MySQL</h2>

<p>Pour installer MySQL câ€™est trÃ¨s simple voir trop simple ğŸ™‚</p>

<p>Installer MySQL:</p>

<pre><code class="language-bash">aptitude install mysql-server
</code></pre>

<p>On est encore dans le cas dâ€™un metapaquet, on valide et câ€™est tout.</p>

<p>Je vous conseil de choisir un mot de passe complexe pour le root de MySQL, moi jâ€™utilise 50 caractÃ¨res avec majuscules, minuscules et chiffres (Pas de caractÃ¨res spÃ©ciaux car jâ€™ai souvent eu des problÃ¨mes aprÃ¨s pour me connecter avec).</p>

<p>Il existe plein de gÃ©nÃ©rateur de mot de passe en ligne, je vous laisse choisir votre prÃ©fÃ©rÃ© moi jâ€™ai pas trouvÃ©. Surement une idÃ©e dâ€™application Ã  faire ğŸ™‚</p>

<p>VoilÃ  le mien : a4HBSwpwdlF3LafNsPswKM6uZQWGIqrjnUGXkNcoYX3XGE5lZV</p>

<p>Ã  conserver prÃ©cieusement car câ€™est le compte root.</p>

<h2>Serveur App â€“ PHP</h2>

<p>Pour PHP aussi pas beaucoup de chose Ã  faire (PHP 5.4) :</p>

<p>Installer PHP:</p>

<pre><code class="language-bash">aptitude install php5
</code></pre>

<p>AprÃ¨s comme pour Apache il y a des modules plus ou moins importants, voici les principaux :</p>

<ul>
<li><a href="https://packages.debian.org/wheezy/php5-mysql">php5-mysql</a> : plutÃ´t indispensable celui lÃ  sinon comment vous connecter Ã  MySQL que vous venez dâ€™installer ? permet dâ€™activer les fonctions mysql_* (ne plus les utiliser svp câ€™est trop horrible et obsolÃ¨te depuis la version 5.5 de PHP), mysqli_* (câ€™est mieux mais bon) et enfin PDO (Ã§a câ€™est la classe)</li>
<li><a href="https://packages.debian.org/wheezy/php5-curl">php5-curl</a> : pour rÃ©cupÃ©rer des fichiers via HTTP ou FTP</li>
<li><a href="https://packages.debian.org/wheezy/php5-gd">php5-gd</a> : pour traiter des images (resize, traitements, â€¦)</li>
<li><a href="https://packages.debian.org/wheezy/php5-mcrypt">php5-mcrypt</a> : pour crypter des donnÃ©es sensibles</li>
<li><a href="https://packages.debian.org/wheezy/libssh2-php">libssh2-php</a> : pour utiliser SSH dans les scripts PHP</li>
</ul>

<p><a href="http://www.prestashop.com/fr/">Prestashop</a> la boutique en ligne et open source que je vous conseil a besoin de php5-curl pour activer Paypal, php5-gd pour retailler les images, php5-mcrypt pour crypter les donnÃ©es sensibles et bien Ã©videmment php5-mysql.</p>

<p><a href="http://wordpress.org/">WordPress</a> le blog open source qui fait aussi CMS a besoin de libssh2-php pour pouvoir faire les mise Ã  jour en automatique</p>

<p>Pour les installer tous il suffit de lancer :</p>

<p>Installer les modules PHP:</p>

<pre><code class="language-bash">aptitude install php5-mysql php5-gd php5-mcrypt php5-curl libssh2-php
</code></pre>

<p>Juste aprÃ¨s ca vous nâ€™avez rien Ã  faire tout est dÃ©jÃ  fonctionnel.</p>

<h2>Serveur Fichier â€“ SFTP</h2>

<p>Pour le serveur de fichier jâ€™utilisais il y a trÃ¨s longtemps des serveurs FTP plus ou moins sÃ©curisÃ©s jusquâ€™au jour ou jâ€™ai dÃ©couvert que SSH le faisait dÃ©jÃ  trÃ¨s bien. Alors pourquoi installer un nouveau service alors quâ€™on en a dÃ©jÃ  un installÃ© et qui tourne ? en plus il y avait la gestion des comptes qui Ã©tait complexe lÃ  câ€™est le mÃªme login et mot de passe.</p>

<p>Vous allez me dire mais jâ€™ai pas envie de donner un accÃ¨s SSH Ã  mes utilisateurs et bien non on leur donne uniquement le SFTP ils peuvent rien faire de plus câ€™est donc totalement sÃ©curisÃ©.</p>

<p>Pour celÃ  il faut juste configurer SSH pour permettre de rendre le service que lâ€™on veut câ€™est Ã  dire offrir aux utilisateurs un accÃ¨s aux fichiers via un client FTP comme filezilla ou un partage de fichiers.</p>

<p>Il faut donc changer la ligne Â« Subsystem â€¦ Â» (avant on avait Â« Subsystem sftp /usr/lib/openssh/sftp-server Â») : On indique autoriser le faux shell Â« internal-sftp Â» qui va permettre dâ€™interdire lâ€™accÃ¨s au shell pour les utilisateurs.</p>

<p>Et rajouter quelques lignes aprÃ¨s Â« UserPAM yes Â». Pour autoriser le groupe www-data qui est celui dâ€™Apache donc de nos sites.</p>

<ul>
<li>ChrootDirectory : les utilisateurs ne pourront pas remonter Ã  la racine du serveur et explorer notre serveur. Ils sont bloquÃ©s dans leur dossier personnel</li>
<li>X11Forwarding : on nâ€™autorise pas le partage de bureau (application graphique Ã  distance)</li>
<li>AllowTcpForwarding : interdire aussi les tunnels SSH</li>
<li>ForceCommand : pour forcer lâ€™utilisation dâ€™un faux shell et interdire donc un accÃ¨s SSH</li>
</ul>

<p>vi /etc/ssh/sshd_config:</p>

<pre><code class="language-bash">Subsystem sftp internal-sftp

# Set this to 'yes' to enable PAM authentication, account processing,
# and session processing. If this is enabled, PAM authentication will
# be allowed through the ChallengeResponseAuthentication and
# PasswordAuthentication. Depending on your PAM configuration,
# PAM authentication via ChallengeResponseAuthentication may bypass
# the setting of "PermitRootLogin without-password".
# If you just want the PAM account and session checks to run without
# PAM authentication, then enable this but set PasswordAuthentication
# and ChallengeResponseAuthentication to 'no'.
UsePAM yes
    AllowGroups www-data
    Match Group www-data
            ChrootDirectory /home/%u
            X11Forwarding no
            AllowTcpForwarding no
            ForceCommand internal-sftp
</code></pre>

<p>Reste Ã  recharger la configuration de notre service :</p>

<p>Recharger SSH:</p>

<pre><code class="language-bash">service ssh reload
</code></pre>

<p>Et voilÃ  nous avons un SFTP sÃ©curisÃ© accessible uniquement aux utilisateurs appartenant au groupe www-data. Pour rappel le fichier de conf a dÃ©jÃ  Ã©tÃ© modifiÃ© pour interdire au root de pouvoir se connecter et nous avons dÃ©jÃ  changÃ© le port par dÃ©faut qui Ã©tait Ã  22 pour plus de sÃ©curitÃ©.</p>

<p>Reste Ã  rajouter des droits car sinon le SFTP interdira de se connecter.</p>

<p>Droits pour SFTP:</p>

<pre><code class="language-bash">chown -R root:www-data /home/
chmod -R 750 /home/
</code></pre>
    </div>

    <nav class="flex justify-between text-sm md:text-base">
        <div>
                            <a href="https://vincent.dauce.fr/blog/2014-02-01-administrer-un-serveur-dedie-part-4-premier-container" title="Older Post: Administrer un serveur dÃ©diÃ© - part 4 : Premier container">
                    &LeftArrow; Administrer un serveur dÃ©diÃ© - part 4 : Premier container
                </a>
                    </div>

        <div>
                            <a href="https://vincent.dauce.fr/blog/2014-02-15-administrer-un-serveur-dedie-part-6-espace-web" title="Newer Post: Administrer un serveur dÃ©diÃ© - part 6 : Espace Web">
                    Administrer un serveur dÃ©diÃ© - part 6 : Espace Web &RightArrow;
                </a>
                    </div>
    </nav>
        </main>

        <footer class="bg-white text-center text-sm mt-12 py-4" role="contentinfo">
            <ul class="flex flex-col md:flex-row justify-center list-none">
                <li class="md:mr-2">
                    &copy; <a href="https://tighten.co" title="Tighten website">Tighten</a> 2025.
                </li>

                <li>
                    Built with <a href="http://jigsaw.tighten.co" title="Jigsaw by Tighten">Jigsaw</a>
                    and <a href="https://tailwindcss.com" title="Tailwind CSS, a utility-first CSS framework">Tailwind CSS</a>.
                </li>
            </ul>
        </footer>

        <script src="/assets/build/js/main.js?id=ab5beb18484060678105469b256b9364"></script>

        <script>
    const navMenu = {
        toggle() {
            const menu = document.getElementById('js-nav-menu');
            menu.classList.toggle('hidden');
            menu.classList.toggle('lg:block');
            document.getElementById('js-nav-menu-hide').classList.toggle('hidden');
            document.getElementById('js-nav-menu-show').classList.toggle('hidden');
        },
    }
</script>
    </body>
</html>
