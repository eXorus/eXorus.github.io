<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <meta name="description" content="crÃ©ation du premier container avec le rÃ©seau et le firewall">

        <meta property="og:title" content="Administrer un serveur dÃ©diÃ© - part 4 : Premier container | Blog de Vincent Dauce"/>
        <meta property="og:type" content="article" />
        <meta property="og:url" content="https://vincent.dauce.fr/blog/2014-02-01-administrer-un-serveur-dedie-part-4-premier-container"/>
        <meta property="og:description" content="crÃ©ation du premier container avec le rÃ©seau et le firewall" />

        <title>Administrer un serveur dÃ©diÃ© - part 4 : Premier container | Blog de Vincent Dauce</title>

        <link rel="home" href="https://vincent.dauce.fr">
        <link rel="icon" href="/favicon.ico">
        <link href="/blog/feed.atom" type="application/atom+xml" rel="alternate" title="Blog de Vincent Dauce Atom Feed">

                    <!-- Fathom - beautiful, simple website analytics -->
            <script src="https://cdn.usefathom.com/script.js" data-site="VSUJDIGQ" defer></script>
            <!-- / Fathom -->
        
        <link href="https://fonts.googleapis.com/css?family=Nunito+Sans:300,300i,400,400i,700,700i,800,800i" rel="stylesheet">
        <link rel="stylesheet" href="/assets/build/css/main.css?id=3717bee9ccac7506b103bbe24c27e2de">
    </head>

    <body class="flex flex-col justify-between min-h-screen bg-gray-100 text-gray-800 leading-normal font-sans">
        <header class="flex items-center shadow bg-white border-b h-24 py-4" role="banner">
            <div class="container flex items-center max-w-8xl mx-auto px-4 lg:px-8">
                <div class="flex items-center">
                    <a href="/" title="Blog de Vincent Dauce home" class="inline-flex items-center">
                        <img class="h-8 md:h-10 mr-3" src="/assets/img/logo.svg" alt="Blog de Vincent Dauce logo" />

                        <h1 class="text-lg md:text-2xl text-blue-800 font-semibold hover:text-blue-600 my-0">Blog de Vincent Dauce</h1>
                    </a>
                </div>

                <div id="vue-search" class="flex flex-1 justify-end items-center">
                    <search></search>

                    <nav class="hidden lg:flex items-center justify-end text-lg">
    <a title="Blog de Vincent Dauce Blog" href="/blog"
        class="ml-6 text-gray-700 hover:text-blue-600 ">
        Blog
    </a>

    <a title="Blog de Vincent Dauce About" href="/about"
        class="ml-6 text-gray-700 hover:text-blue-600 ">
        About
    </a>

    <a title="Blog de Vincent Dauce Contact" href="/contact"
        class="ml-6 text-gray-700 hover:text-blue-600 ">
        Contact
    </a>
</nav>

                    <button class="flex justify-center items-center bg-blue-500 border border-blue-500 h-10 px-5 rounded-full lg:hidden focus:outline-none"
    onclick="navMenu.toggle()"
>
    <svg id="js-nav-menu-show" xmlns="http://www.w3.org/2000/svg"
        class="fill-current text-white h-9 w-4" viewBox="0 0 32 32"
    >
        <path d="M4,10h24c1.104,0,2-0.896,2-2s-0.896-2-2-2H4C2.896,6,2,6.896,2,8S2.896,10,4,10z M28,14H4c-1.104,0-2,0.896-2,2  s0.896,2,2,2h24c1.104,0,2-0.896,2-2S29.104,14,28,14z M28,22H4c-1.104,0-2,0.896-2,2s0.896,2,2,2h24c1.104,0,2-0.896,2-2  S29.104,22,28,22z"/>
    </svg>

    <svg id="js-nav-menu-hide" xmlns="http://www.w3.org/2000/svg"
        class="hidden fill-current text-white h-9 w-4" viewBox="0 0 36 30"
    >
        <polygon points="32.8,4.4 28.6,0.2 18,10.8 7.4,0.2 3.2,4.4 13.8,15 3.2,25.6 7.4,29.8 18,19.2 28.6,29.8 32.8,25.6 22.2,15 "/>
    </svg>
</button>

                </div>
            </div>
        </header>

        <nav id="js-nav-menu" class="w-auto px-2 pt-6 pb-2 bg-gray-200 shadow hidden lg:hidden">
    <ul class="my-0">
        <li class="pl-4">
            <a
                title="Blog de Vincent Dauce Blog"
                href="/blog"
                class="block mt-0 mb-4 text-sm no-underline text-gray-800 hover:text-blue-500"
            >Blog</a>
        </li>
        <li class="pl-4">
            <a
                title="Blog de Vincent Dauce About"
                href="/about"
                class="block mt-0 mb-4 text-sm no-underline text-gray-800 hover:text-blue-500"
            >About</a>
        </li>
        <li class="pl-4">
            <a
                title="Blog de Vincent Dauce Contact"
                href="/contact"
                class="block mt-0 mb-4 text-sm no-underline text-gray-800 hover:text-blue-500"
            >Contact</a>
        </li>
    </ul>
</nav>

        <main role="main" class="flex-auto w-full container max-w-4xl mx-auto py-16 px-6">
                
    <h1 class="leading-none mb-2">Administrer un serveur dÃ©diÃ© - part 4 : Premier container</h1>

    <p class="text-gray-700 text-xl md:mt-0">Vincent Dauce  â€¢  February 1, 2014</p>

                        <a
                href="/blog/categories/admin"
                title="View posts in admin"
                class="inline-block bg-gray-300 hover:bg-blue-200 leading-loose tracking-wide text-gray-800 uppercase text-xs font-semibold rounded mr-4 px-3 pt-px"
            >admin</a>
            
    <div class="border-b border-blue-200 mb-10 pb-4" v-pre>
        <p>AprÃ¨s dÃ©jÃ  3 articles, nous arrivons enfin Ã  notre premier container qui va nous permettre enfin dâ€™hÃ©berger nos sites et rendre service, car câ€™est bien lÃ  le but dâ€™un serveur rendre services aux autres.</p>

<h2>CrÃ©er le container</h2>

<p>CrÃ©er un container</p>

<pre><code class="language-bash">lxc-create -n CT101 -t debian
</code></pre>

<p>Et voilÃ  câ€™est fait, vous avez une Debian 7.4 Ã  jour ğŸ™‚ le mot de passe est root par dÃ©faut on le changera rapidement.</p>

<p>Le nom de votre container câ€™est CT101 quâ€™on devra utiliser dans presque toutes les commandes de LXC.</p>

<p>â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”</p>

<p>25/05/2014 : Modification du masque rÃ©seau (/24 au lieu de rien avant)</p>

<p>â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”</p>

<p>AprÃ¨s lâ€™installation le container est Ã  lâ€™arrÃªt donc dÃ©marrons le :</p>

<p>DÃ©marrer un container:</p>

<pre><code class="language-bash">ln -s /var/lib/lxc/CT101/config /etc/lxc/auto/CT101
lxc-start -n CT101 -d
</code></pre>

<p>La premiÃ¨re permet de dÃ©marrer automatiquement le container Ã  chaque fois que le host dÃ©marre. Et la seconde est pour le dÃ©marrer maintenant car on veut faire mumuse avec ğŸ™‚</p>

<p>Nous allons nous connecter dessus pour commencer Ã  lâ€™utiliser</p>

<p>Se connecter Ã  la console du container CT101:</p>

<pre><code class="language-bash">lxc-console -n CT101
</code></pre>

<p>Quand on tape cette commande la phrase Â« Type &lt;Ctrl+a q&gt; to exit the console, &lt;Ctrl+a Ctrl+a&gt; to enter Ctrl+a itself Â» sâ€™affiche.</p>

<p>Donc avec notre clavier on fait Ctrl+a puis EntrÃ©e pour voir apparaÃ®tre le prompt du login et pouvoir saisir root (le mot de passe est par dÃ©faut root).</p>

<p>A ce moment lÃ  vous Ãªtes connectÃ© Ã  votre container, vous pouvez le voir car le prompt a changÃ© Â« root@CT101:~# Â»</p>

<p>Pour quitter le container et revenir au prompt du host il suffit de faire exit. On revient Ã  ce moment lÃ  au prompt du login et on a plus quâ€™Ã  saisir Ctrl+a puis q.</p>

<p>Le prompt change de nouveau pour nous indiquer que nous sommes sur le host.</p>

<p>La suite est dÃ©jÃ  expliquÃ© dans mon article <a href="http://vincent.dauce.fr/administrer-un-serveur-dedie-part-2-le-socle/" title="Administrer un serveur dÃ©diÃ© â€“ part 2 : Le socle">Administrer un serveur dÃ©diÃ© â€“ part 2 : Le socle</a> (Section : PremiÃ¨res actions et SÃ©curiser le service SSH)</p>

<h2>Configurer le rÃ©seau sur le host</h2>

<p>On va commander un IP Failover sur la console Online, sur la page <a href="https://console.online.net/fr/server/failover">Failover</a>, cliquer sur le bouton Â« Commander des adresses IP Â», sÃ©lectionner celle que vous voulez en fonction de la beautÃ© des chiffres ğŸ™‚ et valider avec le bouton Â« Commander dâ€™IP Failover Â»</p>

<p>AprÃ¨s la commande on retour sur la page <a href="https://console.online.net/fr/server/failover">Failover</a> pour cette fois assigner lâ€™IP Ã  un serveur. Les IP disponibles sont en vert dans la liste des IP Failovers. Il suffit de glisser-dÃ©poser lâ€™IP quâ€™on vient dâ€™acheter sur le serveur que lâ€™on souhaite. Et cliquer sur le bouton Â« Mise Ã  jour Â». Un rÃ©capitulatif des modifications sâ€™affichent puis cliquer sur le bouton Â« Mise Ã  jour Â».</p>

<p>Ma nouvelle adresse IP Failover est : CT101_IP_PUBLIC</p>

<p>Dans la configuration rÃ©seau que nous allons faire nous nâ€™avons pas besoin dâ€™assigner une adresse mac Ã  notre IP car lâ€™IP bien que publique nâ€™est pas connectÃ© en direct mais passe par du NAT.</p>

<p>On va configurer le rÃ©seau Ã  partir du host donc dÃ©connectez vous du container pour suivre les actions ci-dessous.</p>

<p>On va commencer par dÃ©clarer notre IP en tant quâ€™interface rÃ©seau virtuelle sur notre host. Ces quelques lignes sont Ã  rajouter Ã  la fin du fichier aprÃ¨s le bridge que nous avons crÃ©Ã© dans lâ€™article <a href="http://vincent.dauce.fr/administrer-un-serveur-dedie-part-3-virtualisation/" title="Administrer un serveur dÃ©diÃ© â€“ part 3 : Virtualisation">Administrer un serveur dÃ©diÃ© â€“ part 3 : Virtualisation</a></p>

<p>vi /etc/network/interfaces:</p>

<pre><code class="language-bash"># Failover CT101 : CT101_IP_PUBLIC
auto eth0:x
iface eth0:x inet static
        address CT101_IP_PUBLIC
        netmask 255.255.255.255
</code></pre>

<p>Il faut incrÃ©menter le numÃ©ro x Ã  chaque nouvelle IP. Donc eth0 est mon interface principale avec mon lâ€™IP publique de mon serveur, eth0:0 sera lâ€™interface virtuelle de ma premiÃ¨re IP Failover CT101_IP_PUBLIC, eth0:1 sera lâ€™interface virtuelle de ma seconde IP Failover CT102_IP_PUBLIC, eth0:2 sera lâ€™interface virtuelle de ma troisiÃ¨me IP Failover CT103_IP_PUBLIC, â€¦ enfin on est limitÃ© Ã  5 par serveur chez Online.</p>

<p>Le netmask est Ã  255.255.255.255 comme lâ€™indique Online dans sa <a href="http://documentation.online.net/fr/serveur-dedie/reseau/ip-failover">documentation sur lâ€™IP Failover</a>.</p>

<p>Malheureusement cette configuration ne sera prise en compte quâ€™au prochain reboot, donc pour activer notre nouvelle interface maintenant tout de suite on exÃ©cute la commande suivante :</p>

<p>Activer l'IP failover en live:</p>

<pre><code class="language-bash">ifconfig eth0:x CT101_IP_PUBLIC netmask 255.255.255.255
</code></pre>

<h2>Configurer le rÃ©seau sur le container</h2>

<p>On reste sur le host pour configurer le rÃ©seau du container câ€™est plus simple car on est dÃ©jÃ  dessus. Mais câ€™est possible de le faire aussi en Ã©tant connectÃ© sur le container.</p>

<p>Il sâ€™agit donc ici de dÃ©finir un rÃ©seau local entre notre container et le bridge.</p>

<p>Le fichier existe dÃ©jÃ  avec lâ€™interface local et lâ€™interface eth0 que lâ€™on va remplacer.</p>

<p>Nos modifications sont les suivantes :</p>

<ul>
<li>On ne touche pas Ã  la boucle local</li>
<li>Lâ€™interface principale passe en mode manuel (dhcp vers static), câ€™est Ã  dire quâ€™on va spÃ©cifier les informations au lieu de laisser les serveurs DHCP faire le boulot

<ul>
<li>address : IP privÃ©e de notre container (jâ€™utilise toujours 192.168.0.xxx avec xxx le mÃªme numÃ©ro que le nom de mon container donc CT101 est sur lâ€™IP privÃ©e 192.168.0.101 câ€™est plus facile Ã  retenir). Il faut rajouter le masque rÃ©seau /24 indiquant que la boucle local est sur le dernier chiffre de lâ€™IP (ou alors /16 pour indiquer que câ€™est les 2 derniers chiffres Ã  prendre en compte)</li>
<li>broadcast : La mÃªme que ci-dessus avec un 255 Ã  la fin</li>
<li>gateway : Câ€™est lâ€™IP privÃ©e de mon bridge que nous avons dÃ©finit dans lâ€™article prÃ©cÃ©dent (address sur lâ€™interface br0)</li>
</ul></li>
</ul>

<p>vi /var/lib/lxc/CT101/rootfs/etc/network/interfaces:</p>

<pre><code class="language-bash">auto lo
iface lo inet loopback

auto eth0
iface eth0 inet static
        address 192.168.0.101
        netmask 255.255.255.0
        broadcast 192.168.0.255
        gateway 192.168.0.1
</code></pre>

<p>Il y a aussi le fichier de configuration LXC pour le container en question Ã  modifier. Le fichier permet de configurer des tas de choses mais nous allons nous concentrer uniquement sur le rÃ©seau. Normalement les directives ci-dessous nâ€™existent pas donc ajouter les Ã  la fin du fichier :</p>

<p>vi /var/lib/lxc/CT101/config:</p>

<pre><code class="language-bash"># Network
lxc.network.type = veth
lxc.network.flags = up
lxc.network.link = br0
lxc.network.name = eth0
lxc.network.ipv4 = 192.168.0.101/24
lxc.network.veth.pair = vethCT101
</code></pre>

<p>On indique Ã  LXC comment traiter le rÃ©seau de notre container :</p>

<ul>
<li>lxc.network.type : lxc permet dâ€™avoir diffÃ©rent types de rÃ©seaux (phys, vlan, â€¦) nous on a choisir veth câ€™est Ã  dire lâ€™utilisation dâ€™un bridge que nous lui indiquerons dans la directive lxc.network.link</li>
<li>lxc.network.flags : On le met Ã  Â« up Â» pour activer le rÃ©seau</li>
<li>lxc.network.link : on vient de dire Ã  LXC de traiter le rÃ©seau avec un bridge on lui indique ici le nom de lâ€™interface que nous avons mis dans /etc/network/interface du host</li>
<li>lxc.network.name : on utilise lâ€™interface eth0 de notre container, celle que nous venons de configurer ci-dessus avec lâ€™IP 192.168.0.101</li>
<li>lxc.network.ipv4 : cette fois câ€™est notre IP privÃ©e</li>
<li>lxc.network.veth.pair : câ€™est le nom que nous donnons au lien, cf lâ€™image de notre rÃ©seau dans lâ€™article prÃ©cÃ©dent</li>
</ul>

<h2>Configurer le firewall</h2>

<p>Maintenant que notre rÃ©seau est configurÃ© nous allons devoir faire quelques mises Ã  jours sur notre firewall :</p>

<ul>
<li>NAT : câ€™est Ã  dire transformer tous les flux qui sortent de notre container avec lâ€™IP 192.168.0.101 par CT101_IP_PUBLIC et inversement</li>
<li>Autoriser les flux en fonction des services que lâ€™on proposera dans notre container</li>
</ul>

<p>Modifier le firewall que nous avons mis en place dans <a href="http://vincent.dauce.fr/administrer-un-serveur-dedie-part-2-le-socle/" title="Administrer un serveur dÃ©diÃ© â€“ part 2 : Le socle">Administrer un serveur dÃ©diÃ© â€“ part 2 : Le socle</a> (Mise en place dâ€™un firewall)</p>

<p>Pour rajouter les 2 lignes suivantes : dÃ©claration de lâ€™IP publique et privÃ©e de notre container CT101.</p>

<p>vi /etc/init.d/firewall.sh:</p>

<pre><code class="language-bash">HN_IP="xx.xx.xx.xx"

CT101_IP_PRIVATE="192.168.0.101"
CT101_IP_PUBLIC="CT101_IP_PUBLIC"

##########################
# Start the Firewall rules
##########################
</code></pre>

<p>Et et un peu plus loin entre le bloc Â« Autoriser HTTP et HTTPS Â» et la fin du bloc fw_start() :</p>

<p>vi /etc/init.d/firewall.sh:</p>

<pre><code class="language-bash"># Autoriser HTTP et HTTPS
iptables -t filter -A OUTPUT -p tcp --dport $HTTP_PORT -j ACCEPT
iptables -t filter -A INPUT -p tcp --dport $HTTP_PORT -j ACCEPT
iptables -t filter -A OUTPUT -p tcp --dport $HTTPS_PORT -j ACCEPT
iptables -t filter -A INPUT -p tcp --dport $HTTPS_PORT -j ACCEPT

# CT101 : Configuration NAT
iptables -A FORWARD -s $CT101_IP_PRIVATE -j ACCEPT
iptables -A FORWARD -d $CT101_IP_PRIVATE -j ACCEPT
iptables -t nat -A POSTROUTING -s $CT101_IP_PRIVATE -j SNAT --to $CT101_IP_PUBLIC
# CT101 : Autoriser HTTP
iptables -t nat -I PREROUTING -p tcp -d $CT101_IP_PUBLIC --dport $HTTP_PORT -j DNAT --to $CT101_IP_PRIVATE
iptables -I FORWARD -p tcp -d $CT101_IP_PRIVATE --dport $HTTP_PORT
# CT101 : Autoriser SSH
iptables -t nat -I PREROUTING -p tcp -d $CT101_IP_PUBLIC --dport $SSH_PORT -j DNAT --to $CT101_IP_PRIVATE
iptables -I FORWARD -p tcp -d $CT101_IP_PRIVATE --dport $SSH_PORT

}
fw_stop(){
</code></pre>

<p>Il reste Ã  relancer le firewall pour prise en compte des nouvelles rÃ¨gles :</p>

<p>Relancer le firewall:</p>

<pre><code class="language-bash">firewall.sh restart
</code></pre>

<p>Et relancer le container pour prendre en compte les changements rÃ©seaux et de configuration LXC :</p>

<p>Relancer le container:</p>

<pre><code class="language-bash">lxc-stop -n CT101
lxc-list
lxc-start -n CT101 -d
</code></pre>

<p>Et voilÃ , vous avez un container qui a accÃ¨s Ã  internet et qui peut hÃ©berger un serveur web par exemple ğŸ™‚</p>

<p>Ha on me dit que câ€™est dans le prochain article donc je vous laisse.</p>

<p>Vous pouvez rÃ©pÃ©ter ce tuto autant de fois que vous voulez de container.</p>
    </div>

    <nav class="flex justify-between text-sm md:text-base">
        <div>
                            <a href="https://vincent.dauce.fr/blog/2014-01-25-administrer-un-serveur-dedie-part-3-virtualisation" title="Older Post: Administrer un serveur dÃ©diÃ© - part 3 : Virtualisation">
                    &LeftArrow; Administrer un serveur dÃ©diÃ© - part 3 : Virtualisation
                </a>
                    </div>

        <div>
                            <a href="https://vincent.dauce.fr/blog/2014-02-10-administrer-un-serveur-dedie-part-5-serveur-web" title="Newer Post: Administrer un serveur dÃ©diÃ© - part 5 : Serveur Web">
                    Administrer un serveur dÃ©diÃ© - part 5 : Serveur Web &RightArrow;
                </a>
                    </div>
    </nav>
        </main>

        <footer class="bg-white text-center text-sm mt-12 py-4" role="contentinfo">
            <ul class="flex flex-col md:flex-row justify-center list-none">
                <li class="md:mr-2">
                    &copy; <a href="https://tighten.co" title="Tighten website">Tighten</a> 2025.
                </li>

                <li>
                    Built with <a href="http://jigsaw.tighten.co" title="Jigsaw by Tighten">Jigsaw</a>
                    and <a href="https://tailwindcss.com" title="Tailwind CSS, a utility-first CSS framework">Tailwind CSS</a>.
                </li>
            </ul>
        </footer>

        <script src="/assets/build/js/main.js?id=ab5beb18484060678105469b256b9364"></script>

        <script>
    const navMenu = {
        toggle() {
            const menu = document.getElementById('js-nav-menu');
            menu.classList.toggle('hidden');
            menu.classList.toggle('lg:block');
            document.getElementById('js-nav-menu-hide').classList.toggle('hidden');
            document.getElementById('js-nav-menu-show').classList.toggle('hidden');
        },
    }
</script>
    </body>
</html>
